# SWRN 지능형 검색 및 분석 시스템 기술 백서

## SQLite FTS5 및 로컬 LLM 기반 반도체 장비 기술 문서 분석 시스템

**최종 업데이트:** 2025-12-05  
**버전:** 2.5.0

---

## 0. 프로젝트 구조 및 Python 모듈 관계

### 0.1 프로젝트 파일 구조

```
flask_dashboard_project/
├── 📄 Main_SSS.py              # Flask 메인 서버 (Port 8060)
├── 📄 config.py                # 환경 설정 및 경로 관리
├── 📄 local_rag.py             # TF-IDF RAG 시스템 + Ollama LLM
├── 📄 swrn_indexer.py          # SWRN PDF 인덱서 (SQLite FTS5)
├── 📄 requirements.txt         # Python 패키지 의존성
├── 📄 deploy.ps1               # 서버 배포 스크립트
├── 📄 start_server.bat         # 서버 시작 스크립트
├── 📁 data/                    # 데이터 저장소
│   ├── 📁 SWRN/               # SWRN PDF 파일들 (416개)
│   ├── 📁 search_index/       # 검색 인덱스
│   ├── 📄 swrn_index.db       # SQLite FTS5 데이터베이스
│   ├── 📄 tfidf_cache.pkl     # TF-IDF 벡터 캐시
│   ├── 📄 users.json          # 사용자 인증 (암호화)
│   ├── 📄 Issues Tracking.csv # 이슈 트래킹 데이터
│   ├── 📄 SW_IB_Version.csv   # SW 설치 버전 정보
│   └── 📄 TableExport.csv     # iPLM PR 상태 데이터
├── 📁 static/                  # 정적 파일 (CSS, JS)
├── 📁 templates/               # HTML 템플릿
│   ├── 📄 dashboard.html      # 메인 대시보드
│   └── 📄 login.html          # 로그인 페이지
├── 📁 local_rag_index/        # RAG 인덱스 캐시
├── 📁 documentation/          # 기술 문서
└── 📁 _archive/               # 아카이브 (백업/배포 스크립트)
```

### 0.2 Python 모듈 간 유기적 관계

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Python 모듈 의존성 다이어그램                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                          ┌─────────────────┐                                │
│                          │   config.py     │                                │
│                          │  (환경 설정)     │                                │
│                          └────────┬────────┘                                │
│                                   │                                         │
│              ┌────────────────────┼────────────────────┐                    │
│              │                    │                    │                    │
│              ▼                    ▼                    ▼                    │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│   │  Main_SSS.py    │  │  local_rag.py   │  │ swrn_indexer.py │            │
│   │  (Flask 서버)   │  │  (RAG 시스템)   │  │ (PDF 인덱서)    │            │
│   └────────┬────────┘  └────────┬────────┘  └────────┬────────┘            │
│            │                    │                    │                      │
│            │    imports         │    imports         │                      │
│            └───────────────────►│◄───────────────────┘                      │
│                                 │                                           │
│            ┌────────────────────┼────────────────────┐                      │
│            │                    │                    │                      │
│            ▼                    ▼                    ▼                      │
│   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐            │
│   │  Flask Routes   │  │  TF-IDF Search  │  │  SQLite FTS5    │            │
│   │  (20+ 엔드포인트)│  │  + Ollama LLM   │  │  + PR Extractor │            │
│   └─────────────────┘  └─────────────────┘  └─────────────────┘            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 0.3 모듈별 핵심 역할

| 모듈 | 역할 | 주요 클래스/함수 | 라인 수 |
|------|------|-----------------|---------|
| **config.py** | 환경 자동 감지 및 경로 설정 | `Config`, `get_data_file()` | ~125 |
| **Main_SSS.py** | Flask 웹 서버, 라우팅, 인증 | `login_required`, 20+ routes | ~3,200 |
| **local_rag.py** | RAG 파이프라인, TF-IDF, LLM | `LocalRAGSystem`, `query()` | ~3,100 |
| **swrn_indexer.py** | PDF 파싱, SQLite FTS5 인덱싱 | `SWRNIndexer`, `get_pr_detail()` | ~2,750 |

### 0.4 데이터 흐름 및 호출 관계

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         사용자 요청 처리 흐름                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [브라우저] ──HTTP 요청──▶ [Main_SSS.py]                                   │
│                                │                                            │
│         ┌──────────────────────┴──────────────────────┐                    │
│         │                      │                      │                    │
│         ▼                      ▼                      ▼                    │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │ /dashboard   │    │ /chat (AI)   │    │ /swrn_search │                  │
│  │ /issue_stats │    │ /rag/status  │    │ /pr_compare  │                  │
│  │ /ticket_stats│    │              │    │              │                  │
│  └──────┬───────┘    └──────┬───────┘    └──────┬───────┘                  │
│         │                   │                   │                          │
│         │                   │                   │                          │
│         ▼                   ▼                   ▼                          │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                  │
│  │  CSV/Excel   │    │ local_rag.py │    │swrn_indexer  │                  │
│  │  데이터 로드  │    │              │    │    .py       │                  │
│  └──────────────┘    │ LocalRAGSystem│   │              │                  │
│                      │  .query()     │   │ SWRNIndexer  │                  │
│                      └──────┬───────┘    │ .search()    │                  │
│                             │            └──────┬───────┘                  │
│                             │                   │                          │
│                      ┌──────▼───────┐    ┌──────▼───────┐                  │
│                      │ swrn_indexer │    │ swrn_index.db│                  │
│                      │ .get_pr_info │    │  (SQLite)    │                  │
│                      └──────┬───────┘    └──────────────┘                  │
│                             │                                              │
│                      ┌──────▼───────┐                                      │
│                      │ Ollama LLM   │                                      │
│                      │ (llama3.2)   │                                      │
│                      └──────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 0.5 인증 시스템 (Session 기반)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         인증 흐름 (Main_SSS.py)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [사용자] ──/login──▶ [login.html] ──POST──▶ [/login 라우트]               │
│                                                    │                        │
│                                                    ▼                        │
│                                      ┌─────────────────────────┐            │
│                                      │ load_users()            │            │
│                                      │ • XOR 복호화            │            │
│                                      │ • SHA256 비밀번호 검증   │            │
│                                      └───────────┬─────────────┘            │
│                                                  │                          │
│                              ┌───────────────────┴───────────────────┐      │
│                              │                                       │      │
│                      [인증 성공]                              [인증 실패]   │
│                              │                                       │      │
│                              ▼                                       ▼      │
│                 ┌─────────────────────────┐        ┌─────────────────────┐  │
│                 │ session['user'] = ...   │        │ log_access(failed)  │  │
│                 │ redirect('/dashboard')  │        │ return error        │  │
│                 └─────────────────────────┘        └─────────────────────┘  │
│                              │                                              │
│                              ▼                                              │
│                 ┌─────────────────────────┐                                 │
│                 │ @login_required         │                                 │
│                 │ 모든 보호된 라우트에 적용 │                                │
│                 └─────────────────────────┘                                 │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 개요

### 1.1 시스템 목적
본 시스템은 반도체 장비 제조사의 소프트웨어 릴리즈 노트(SWRN)와 이슈 트래킹 데이터를 통합 분석하여, 엔지니어에게 최적의 문제 해결 정보를 제공하는 지능형 검색 솔루션입니다. 단순 키워드 검색을 넘어, 도메인 특화 알고리즘과 로컬 LLM(Large Language Model)을 결합하여 문맥 기반의 질의응답을 제공합니다.

### 1.2 핵심 기능
- **하이브리드 검색 엔진**: SQLite FTS5(키워드 정밀 검색) + TF-IDF(문서 유사도 검색) 결합
- **로컬 LLM 기반 RAG**: Llama-3.2-3B 모델을 활용한 오프라인 보안 질의응답 (데이터 유출 방지)
- **도메인 특화 분석**: 반도체 장비 용어(WHERE+WHAT) 인식 및 PR(Problem Report) 추적 알고리즘
- **자동 인덱싱**: PDF 문서 및 CSV/Excel 데이터 자동 동기화 및 증분 인덱싱

---

## 2. 시스템 아키텍처
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Flask Dashboard (Main_SSS.py)                         │
│                              Port 8060                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   Charts    │    │  PR Status  │    │  SWRN Search│    │  AI Chat    │  │
│  │  Dashboard  │    │   Tracking  │    │   (FTS5)    │    │   (RAG)     │  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘  │
│         │                  │                  │                  │          │
└─────────┼──────────────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │                  │
          ▼                  ▼                  ▼                  ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   CSV/Excel     │  │  TableExport    │  │  swrn_index.db  │  │  local_rag.py   │
│   Data Files    │  │    .csv         │  │   (SQLite)      │  │                 │
│                 │  │                 │  │                 │  │  ┌───────────┐  │
│ • Issues        │  │ • PR Status     │  │ • pdf_files     │  │  │ TF-IDF    │  │
│   Tracking.csv  │  │ • Open/Closed   │  │ • page_content  │  │  │ Vectorizer│  │
│ • SW_IB_Version │  │ • Days Open     │  │   (FTS5)        │  │  └─────┬─────┘  │
│ • FiF Upgrade   │  │                 │  │ • pr_index      │  │        │        │
│   Plan.xlsx     │  │                 │  │                 │  │        ▼        │
└─────────────────┘  └─────────────────┘  └────────┬────────┘  │  ┌───────────┐  │
                                                   │           │  │  Llama    │  │
                                                   │           │  │  3.2-3B   │  │
                                                   ▼           │  │  (GGUF)   │  │
                                          ┌─────────────────┐  │  └───────────┘  │
                                          │  swrn_indexer   │  └─────────────────┘
                                          │     .py         │
                                          │                 │
                                          │ • PDF Parsing   │
                                          │ • PR Extraction │
                                          │ • Keyword Algo  │
                                          └─────────────────┘
### 2.1 전체 시스템 데이터 흐름

```mermaid
graph TD
    subgraph "Data Sources"
        PDF[SWRN PDF Files]
        CSV[Issue Tracking CSV]
        Excel[Upgrade Plan Excel]
    end

    subgraph "Indexing Engine"
        PyMuPDF[PyMuPDF Text Extraction]
        FTS5[SQLite FTS5 Indexer]
        TFIDF[TF-IDF Vectorizer]
    end

    subgraph "Storage"
        DB[(SQLite DB - FTS5)]
        Pickle[(TF-IDF Matrix .pkl)]
    end

    subgraph "RAG Pipeline"
        Query[User Query]
        Search[Hybrid Search (FTS5 + TF-IDF)]
        Context[Context Assembly]
        LLM[Llama-3.2-3B (GGUF)]
    end

    PDF --> PyMuPDF --> FTS5 --> DB
    CSV & Excel --> TFIDF --> Pickle
    
    Query --> Search
    DB --> Search
    Pickle --> Search
    Search --> Context
    Context --> LLM --> Response
```

### 2.2 전체 시스템 운영 흐름

┌─────────────────────────────────────────────────────────────────────────────┐
│                         전체 시스템 데이터 흐름                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [시작: 서버 기동]                                                          │
│        │                                                                    │
│        ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. auto_index_swrn() - 백그라운드 스레드                             │   │
│  │    ├── SWRN 폴더 스캔 (data/SWRN/*.pdf)                             │   │
│  │    ├── 새 PDF 파일 감지                                              │   │
│  │    ├── PyMuPDF로 텍스트 추출                                         │   │
│  │    ├── FTS5 테이블에 인덱싱                                          │   │
│  │    └── PR 번호 추출 → pr_index 테이블                                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2. LocalRAGSystem 초기화                                             │   │
│  │    ├── TF-IDF Vectorizer 로드                                        │   │
│  │    ├── CSV/Excel 데이터 로드 → TF-IDF 인덱스 구축                   │   │
│  │    └── GGUF 모델 로드 (Llama 3.2-3B)                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        ▼                                                                    │
│  [대기: 사용자 요청]                                                        │
│        │                                                                    │
│  ══════╪════════════════════════════════════════════════════════════════   │
│        │                                                                    │
│  [사용자 질문: "PR-123456 알려줘"]                                          │
│        │                                                                    │
│        ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3. /chat API 호출                                                    │   │
│  │    ├── 쿼리 분석 (PR 번호 감지)                                      │   │
│  │    ├── swrn_indexer.get_pr_detail("PR-123456")                      │   │
│  │    │   ├── FTS5 검색 → 페이지 위치 확인                             │   │
│  │    │   ├── PDF 열기 → 상세 텍스트 추출                              │   │
│  │    │   └── 필드 파싱 (Title, Root Cause, Solution...)               │   │
│  │    └── RAG 응답 생성                                                 │   │
│  │        ├── 컨텍스트 + 질문 → 프롬프트 구성                          │   │
│  │        └── Llama 3.2-3B → 자연어 응답                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        ▼                                                                    │
│  [응답 반환: HTML 포맷 + AI 설명]                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

---

## 3. Flask 웹 프레임워크 개요

### 3.1 Flask란?

Flask는 Python 기반의 경량 웹 프레임워크(Micro Web Framework)로, 웹 애플리케이션과 REST API를 빠르게 개발할 수 있도록 설계되었습니다.

#### Flask 아키텍처 및 동작 원리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Flask 웹 프레임워크 개요                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Flask = "Micro" Framework                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  "Micro"의 의미:                                                     │   │
│  │  • 핵심 기능만 내장 (라우팅, 요청/응답, 템플릿)                       │   │
│  │  • 데이터베이스, 인증 등은 확장 패키지로 선택적 추가                  │   │
│  │  • 가볍고 빠른 시작, 필요에 따라 확장 가능                           │   │
│  │                                                                       │   │
│  │  vs Django (Full-Stack Framework):                                   │   │
│  │  ┌─────────────────┐     ┌─────────────────┐                         │   │
│  │  │ Flask           │     │ Django          │                         │   │
│  │  │ • 자유로운 구조 │     │ • 정해진 구조   │                         │   │
│  │  │ • 필요한것만    │     │ • 모든것 내장   │                         │   │
│  │  │ • ~5000 LoC     │     │ • ~50000 LoC    │                         │   │
│  │  └─────────────────┘     └─────────────────┘                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Flask 요청-응답 처리 흐름

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Flask 요청-응답 처리 파이프라인                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   클라이언트                                                                 │
│   (브라우저/API)                                                             │
│        │                                                                    │
│        │ HTTP 요청                                                          │
│        │ GET /dashboard                                                     │
│        ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    WSGI 서버 (Werkzeug)                               │   │
│  │                                                                       │   │
│  │   • HTTP 프로토콜 파싱                                                │   │
│  │   • Request 객체 생성                                                 │   │
│  │   • 멀티스레드/프로세스 관리                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        ▼                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Flask Application                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                    URL 라우터                                  │    │   │
│  │  │                                                                │    │   │
│  │  │   @app.route('/dashboard')  ──────────────────────┐           │    │   │
│  │  │   @app.route('/api/data')   ──────────────────┐   │           │    │   │
│  │  │   @app.route('/chat', methods=['POST']) ──┐   │   │           │    │   │
│  │  │                                           │   │   │           │    │   │
│  │  └───────────────────────────────────────────┼───┼───┼───────────┘    │   │
│  │                                              │   │   │                │   │
│  │                                              ▼   ▼   ▼                │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                    View Functions                            │    │   │
│  │  │                                                               │    │   │
│  │  │   def dashboard():          def api_data():    def chat():   │    │   │
│  │  │       data = load_csv()         return jsonify()   ...       │    │   │
│  │  │       return render_template('dashboard.html', data=data)    │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                              │                        │   │
│  │                                              ▼                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │                    Jinja2 템플릿 엔진                         │    │   │
│  │  │                                                               │    │   │
│  │  │   dashboard.html:                                             │    │   │
│  │  │   <html>                                                      │    │   │
│  │  │     <h1>{{ title }}</h1>                                      │    │   │
│  │  │     {% for item in data %}                                    │    │   │
│  │  │       <div>{{ item.name }}</div>                              │    │   │
│  │  │     {% endfor %}                                              │    │   │
│  │  │   </html>                                                     │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│        │                                                                    │
│        │ HTTP 응답                                                          │
│        │ 200 OK + HTML/JSON                                                 │
│        ▼                                                                    │
│   클라이언트                                                                 │
│   (렌더링 완료)                                                              │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 본 시스템에서의 Flask 활용

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SWRN Dashboard - Flask 구조                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   app.py (메인 애플리케이션)                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │  from flask import Flask, render_template, jsonify, request         │  │
│   │                                                                      │  │
│   │  app = Flask(__name__)                                              │  │
│   │                                                                      │  │
│   │  # ────────────────────────────────────────────────────────────     │  │
│   │  # 라우트 정의                                                       │  │
│   │  # ────────────────────────────────────────────────────────────     │  │
│   │                                                                      │  │
│   │  @app.route('/')                                                    │  │
│   │  def index():                    ──► 메인 대시보드 페이지            │  │
│   │      return render_template('dashboard.html')                       │  │
│   │                                                                      │  │
│   │  @app.route('/api/chart-data')                                      │  │
│   │  def chart_data():               ──► Chart.js용 JSON 데이터         │  │
│   │      data = load_csv_data()                                         │  │
│   │      return jsonify(data)                                           │  │
│   │                                                                      │  │
│   │  @app.route('/api/search')                                          │  │
│   │  def search():                   ──► SWRN FTS5 검색 API             │  │
│   │      query = request.args.get('q')                                  │  │
│   │      results = swrn_indexer.search(query)                           │  │
│   │      return jsonify(results)                                        │  │
│   │                                                                      │  │
│   │  @app.route('/chat', methods=['POST'])                              │  │
│   │  def chat():                     ──► AI RAG 채팅 API                │  │
│   │      message = request.json['message']                              │  │
│   │      response = rag_system.query(message)                           │  │
│   │      return jsonify({'response': response})                         │  │
│   │                                                                      │  │
│   │  if __name__ == '__main__':                                         │  │
│   │      app.run(host='0.0.0.0', port=8060, threaded=True)             │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   프로젝트 구조:                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   flask_dashboard_project/                                          │  │
│   │   │                                                                  │  │
│   │   ├── app.py                 # Flask 메인 애플리케이션               │  │
│   │   ├── local_rag.py           # RAG 시스템 모듈                       │  │
│   │   ├── swrn_indexer.py        # PDF 인덱싱 모듈                       │  │
│   │   │                                                                  │  │
│   │   ├── templates/             # Jinja2 HTML 템플릿                    │  │
│   │   │   └── dashboard.html                                            │  │
│   │   │                                                                  │  │
│   │   ├── static/                # 정적 파일 (CSS, JS)                   │  │
│   │   │   ├── style.css                                                 │  │
│   │   │   └── chart.min.js                                              │  │
│   │   │                                                                  │  │
│   │   └── data/                  # 데이터 파일                           │  │
│   │       ├── Issues Tracking.csv                                       │  │
│   │       └── SWRN/              # PDF 문서 폴더                         │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### Flask의 핵심 기능과 본 시스템 활용

| Flask 기능 | 설명 | 본 시스템 활용 |
|-----------|------|---------------|
| **라우팅** | URL → 함수 매핑 | `/`, `/api/search`, `/chat` 엔드포인트 |
| **템플릿** | Jinja2 동적 HTML | `dashboard.html` 차트/테이블 렌더링 |
| **JSON API** | `jsonify()` 응답 | Chart.js 데이터, 검색 결과, AI 응답 |
| **요청 처리** | `request` 객체 | POST 데이터, 쿼리 파라미터 파싱 |
| **정적 파일** | `/static/` 자동 서빙 | CSS, JavaScript 파일 제공 |
| **스레딩** | `threaded=True` | 동시 요청 처리 (AI 응답 대기 중에도) |

---

## 4. 검색 및 인덱싱 기술

### 4.1 PyMuPDF를 활용한 PDF 텍스트 추출

본 시스템은 PyMuPDF(fitz) 라이브러리를 사용하여 SWRN PDF 문서에서 텍스트를 고속으로 추출합니다.

#### PyMuPDF 처리 파이프라인

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PyMuPDF PDF 텍스트 추출 아키텍처                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    1단계: PDF 파일 로드                               │   │
│  │                                                                       │   │
│  │   import fitz  # PyMuPDF                                             │   │
│  │                                                                       │   │
│  │   ┌─────────────────┐      ┌─────────────────────────────────────┐  │   │
│  │   │ PDF 파일        │      │ fitz.open() 처리                     │  │   │
│  │   │                 │─────►│                                     │  │   │
│  │   │ SWRN_v1.8.4.pdf │      │ • MuPDF C 엔진 바인딩               │  │   │
│  │   │ (500+ 페이지)   │      │ • 메모리 매핑 (대용량 최적화)       │  │   │
│  │   └─────────────────┘      │ • 페이지 인덱스 구축                │  │   │
│  │                            └─────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                         │                                   │
│                                         ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    2단계: 페이지별 병렬 처리                          │   │
│  │                                                                       │   │
│  │   doc = fitz.open(pdf_path)                                          │   │
│  │   for page_num in range(len(doc)):                                   │   │
│  │       page = doc[page_num]                                           │   │
│  │       text = page.get_text("text")  # 텍스트 추출                    │   │
│  │                                                                       │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐       ┌─────────┐           │   │
│  │   │ Page 1  │  │ Page 2  │  │ Page 3  │  ...  │ Page N  │           │   │
│  │   │         │  │         │  │         │       │         │           │   │
│  │   │ get_text│  │ get_text│  │ get_text│       │ get_text│           │   │
│  │   └────┬────┘  └────┬────┘  └────┬────┘       └────┬────┘           │   │
│  │        │            │            │                 │                 │   │
│  │        ▼            ▼            ▼                 ▼                 │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │              텍스트 스트림 수집                               │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                         │                                   │
│                                         ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    3단계: 텍스트 정규화 및 정제                       │   │
│  │                                                                       │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │  원본 추출 텍스트:                                           │   │   │
│  │   │  "PR-123456\n\nTitle:  RF power   mismatch\n\n\n"           │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │   ┌──────────────────────────────────────────────────────────────┐  │   │
│  │   │  정규화 처리:                                                 │  │   │
│  │   │  • 연속 공백 제거: /\s+/ → " "                               │  │   │
│  │   │  • 연속 개행 정리: /\n{3,}/ → "\n\n"                         │  │   │
│  │   │  • 특수문자 정규화: 유니코드 → ASCII                         │  │   │
│  │   │  • 하이픈 연결 복원: "mis-\nmatch" → "mismatch"              │  │   │
│  │   └──────────────────────────────────────────────────────────────┘  │   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │  정제된 텍스트:                                              │   │   │
│  │   │  "PR-123456 Title: RF power mismatch"                       │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                         │                                   │
│                                         ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    4단계: PR 번호 추출 및 메타데이터                   │   │
│  │                                                                       │   │
│  │   정규식 패턴: r'PR[-\s]?(\d{5,7})'                                  │   │
│  │                                                                       │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │  텍스트 스캔:                                                │   │   │
│  │   │  "...fixed PR-123456 and PR-234567..."                      │   │   │
│  │   │            ↓              ↓                                  │   │   │
│  │   │      [PR-123456]    [PR-234567]                             │   │   │
│  │   │            ↓              ↓                                  │   │   │
│  │   │  ┌─────────────────────────────────────────────────────┐   │   │   │
│  │   │  │  pr_index 테이블:                                    │   │   │   │
│  │   │  │  ├── pr_number: "PR-123456"                         │   │   │   │
│  │   │  │  ├── file_id: 42                                    │   │   │   │
│  │   │  │  ├── page_num: 15                                   │   │   │   │
│  │   │  │  └── context: "...RF power fixed PR-123456..."      │   │   │   │
│  │   │  └─────────────────────────────────────────────────────┘   │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                         │                                   │
│                                         ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    5단계: FTS5 인덱스 저장                            │   │
│  │                                                                       │   │
│  │   INSERT INTO page_content(file_id, page_num, content)              │   │
│  │   VALUES (42, 15, '정제된 텍스트...');                              │   │
│  │                                                                       │   │
│  │   ┌──────────────────────────────────────────────────────────────┐  │   │
│  │   │              SQLite FTS5 인덱스                                │  │   │
│  │   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐   │  │   │
│  │   │  │ 역인덱스    │  │ 위치 정보   │  │ 문서 메타데이터     │   │  │   │
│  │   │  │             │  │             │  │                     │   │  │   │
│  │   │  │ RF→[15,23]  │  │ RF@15:pos3  │  │ file_id=42          │   │  │   │
│  │   │  │ power→[15]  │  │ power@15:4  │  │ page_count=500      │   │  │   │
│  │   │  └─────────────┘  └─────────────┘  └─────────────────────┘   │  │   │
│  │   └──────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### PyMuPDF 성능 최적화 기법

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    PyMuPDF 최적화 전략                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 증분 인덱싱 (Incremental Indexing)                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │   기존 파일 목록        새 파일 스캔         변경분만 처리            │   │
│  │   ┌───────────┐        ┌───────────┐        ┌───────────┐           │   │
│  │   │ DB 저장   │        │ 디스크    │        │ 신규 파일 │           │   │
│  │   │ • file_a  │  비교  │ • file_a  │  ───►  │ • file_c  │           │   │
│  │   │ • file_b  │  ───►  │ • file_b  │        │ (only)    │           │   │
│  │   │           │        │ • file_c  │        │           │           │   │
│  │   └───────────┘        └───────────┘        └───────────┘           │   │
│  │                                                                      │   │
│  │   비교 기준: mtime (수정시간) + size (파일크기)                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  2. 메모리 효율적 처리                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │   # 페이지 단위 처리 (전체 로드 방지)                                │   │
│  │   with fitz.open(pdf_path) as doc:                                  │   │
│  │       for page in doc:                                              │   │
│  │           text = page.get_text()                                    │   │
│  │           process(text)                                             │   │
│  │           # 페이지 메모리 자동 해제                                  │   │
│  │                                                                      │   │
│  │   ┌────────────────────────────────────────────────────────────┐   │   │
│  │   │  메모리 사용 패턴:                                          │   │   │
│  │   │                                                             │   │   │
│  │   │  전체 로드: ████████████████████████████ 500MB              │   │   │
│  │   │  페이지별:  ████ 50MB (10x 절약)                            │   │   │
│  │   └────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  3. 텍스트 추출 모드 선택                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                      │   │
│  │   page.get_text(option)  옵션별 특성:                               │   │
│  │                                                                      │   │
│  │   "text"  → 순수 텍스트 (속도: ★★★★★, 정확도: ★★★)                │   │
│  │   "blocks"→ 블록 단위   (속도: ★★★★, 정확도: ★★★★)               │   │
│  │   "dict"  → 구조화 JSON (속도: ★★★, 정확도: ★★★★★)               │   │
│  │   "html"  → HTML 포맷   (속도: ★★, 정확도: ★★★★★)                 │   │
│  │                                                                      │   │
│  │   본 시스템: "text" 모드 사용 (속도 우선, 대량 문서 처리)           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### PyMuPDF vs 다른 PDF 라이브러리 비교

| 특성 | PyMuPDF (fitz) | PyPDF2 | pdfplumber | pdfminer |
|-----|----------------|--------|------------|----------|
| **속도** | ★★★★★ 최고 | ★★★ | ★★ | ★★ |
| **정확도** | ★★★★ | ★★★ | ★★★★★ | ★★★★ |
| **메모리** | 효율적 (C 기반) | 보통 | 높음 | 높음 |
| **테이블 추출** | 기본 지원 | ❌ | ★★★★★ | ★★★ |
| **이미지 추출** | ★★★★★ | ★★ | ★★★ | ❌ |
| **한글 지원** | ★★★★★ | ★★★★ | ★★★★ | ★★★★ |
| **라이선스** | AGPL/Commercial | BSD | MIT | MIT |

**PyMuPDF 선택 이유**: SWRN 문서는 대용량(500+ 페이지)이며, 빠른 텍스트 추출이 우선. 테이블 구조보다 텍스트 검색이 주목적.

---

### 4.2 SQLite FTS5 인덱싱 프로세스

SWRN PDF 문서는 SQLite의 FTS5(Full-Text Search 5) 엔진을 통해 인덱싱됩니다.

- **가상 테이블 구조**: `CREATE VIRTUAL TABLE page_content USING fts5(...)`
- **토크나이저**: `unicode61` (다국어 지원, 대소문자 무시, 분음 부호 제거)
- **인덱싱 단위**: 페이지 단위로 텍스트를 분할하여 저장, PR 번호는 별도 메타데이터 테이블에 매핑
- **증분 인덱싱**: 파일의 수정 시간과 크기를 비교하여 변경된 파일만 재처리
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Flask Dashboard (app.py)                          │
│                              Port 8060                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   Charts    │    │  PR Status  │    │  SWRN Search│    │  AI Chat    │  │
│  │  Dashboard  │    │   Tracking  │    │   (FTS5)    │    │   (RAG)     │  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘  │
│         │                  │                  │                  │          │
└─────────┼──────────────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │                  │
          ▼                  ▼                  ▼                  ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│   CSV/Excel     │  │  TableExport    │  │  swrn_index.db  │  │  local_rag.py   │
│   Data Files    │  │    .csv         │  │   (SQLite)      │  │                 │
│                 │  │                 │  │                 │  │  ┌───────────┐  │
│ • Issues        │  │ • PR Status     │  │ • pdf_files     │  │  │ TF-IDF    │  │
│   Tracking.csv  │  │ • Open/Closed   │  │ • page_content  │  │  │ Vectorizer│  │
│ • SW_IB_Version │  │ • Days Open     │  │   (FTS5)        │  │  └─────┬─────┘  │
│ • FiF Upgrade   │  │                 │  │ • pr_index      │  │        │        │
│   Plan.xlsx     │  │                 │  │                 │  │        ▼        │
└─────────────────┘  └─────────────────┘  └────────┬────────┘  │  ┌───────────┐  │
                                                   │           │  │  Llama    │  │
                                                   │           │  │  3.2-3B   │  │
                                                   ▼           │  │  (GGUF)   │  │
                                          ┌─────────────────┐  │  └───────────┘  │
                                          │  swrn_indexer   │  └─────────────────┘
                                          │     .py         │
                                          │                 │
                                          │ • PDF Parsing   │
                                          │ • PR Extraction │
                                          │ • Keyword Algo  │
                                          └─────────────────┘
                                          
┌──────────────────────────────────────────────────────────────────┐
│                    FTS5 인덱싱 프로세스                           │
├──────────────────────────────────────────────────────────────────┤
│                                                                  │
│  PDF 문서                    토큰화                 역인덱스      │
│  ┌────────────┐           ┌─────────┐           ┌─────────────┐ │
│  │ "RF power  │  ──────►  │ rf      │  ──────►  │ rf → [1,5,9]│ │
│  │  mismatch  │           │ power   │           │ power→[1,3] │ │
│  │  in Kiyo"  │           │ mismatch│           │ mismatch→[1]│ │
│  └────────────┘           │ kiyo    │           │ kiyo → [1,7]│ │
│                           └─────────┘           └─────────────┘ │
│                                                                  │
│  검색 쿼리: "RF power"                                          │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ SELECT * FROM page_content WHERE page_content MATCH 'RF power'│
│  │                                                              │ │
│  │ 결과: BM25 랭킹 알고리즘으로 관련도 정렬                      │ │
│  └────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────┘

# swrn_indexer.py의 테이블 구조

# 1. PDF 파일 메타데이터
pdf_files:
├── id (PK)
├── filename        # "Version_1.8.4-SP34_ReleaseNotes.pdf"
├── sw_version      # "1.8.4-SP34"
├── page_count      # 1500
└── indexed_at      # "2025-12-01T10:30:00"

# 2. 페이지별 전문 검색 (FTS5)
page_content (FTS5 Virtual Table):
├── file_id
├── page_num
└── content         # 전체 페이지 텍스트

# 3. PR 번호 빠른 검색용 인덱스
pr_index:
├── pr_number (PK)  # "PR-123456"
├── file_id
├── page_num
└── context         # PR 주변 200자
### 4.3 TF-IDF 벡터화 및 계산 공식

정형 데이터(CSV, Excel)는 scikit-learn의 TF-IDF 알고리즘을 사용하여 벡터화됩니다.
┌─────────────────────────────────────────────────────────────────┐
│                    TF-IDF 계산 공식                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  TF(t,d) = 문서 d에서 단어 t의 출현 빈도 / 문서 d의 전체 단어 수  │
│                                                                 │
│  IDF(t) = log(전체 문서 수 / 단어 t가 등장한 문서 수)            │
│                                                                 │
│  TF-IDF(t,d) = TF(t,d) × IDF(t)                                 │
│                                                                 │
│  예시:                                                          │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ 문서: "RF power mismatch causes chamber pressure error"  │  │
│  │                                                          │  │
│  │ "RF"      → TF=1/7, IDF=높음 (특수 용어) → 높은 TF-IDF   │  │
│  │ "causes"  → TF=1/7, IDF=낮음 (일반 단어) → 낮은 TF-IDF   │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
**설정 파라미터:**
- `ngram_range=(1, 2)`: 단일 단어 및 2단어 조합(Bigram) 고려
- `max_features=10000`: 상위 1만 개 주요 키워드만 추출하여 노이즈 제거
- `stop_words='english'`: 일반적인 불용어 제거

**계산 공식:**
특정 단어 $t$가 문서 $d$에 갖는 가중치 $W_{t,d}$는 다음과 같습니다.

$$
W_{t,d} = \text{tf}_{t,d} \times \text{idf}_t
$$

$$
\text{idf}_t = \log \frac{N}{1 + \text{df}_t}
$$

- $\text{tf}_{t,d}$: 문서 $d$에서 단어 $t$의 등장 빈도
- $\text{df}_t$: 단어 $t$가 등장한 전체 문서의 수
- $N$: 전체 문서의 수

---

## 5. RAG (Retrieval-Augmented Generation) 파이프라인
┌─────────────────────────────────────────────────────────────────────────┐
│                        RAG 파이프라인                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  사용자 질문                                                             │
│  "PR-123456의 Root Cause가 뭐야?"                                       │
│         │                                                               │
│         ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 1. RETRIEVAL (검색)                                              │   │
│  │    ┌────────────────┐    ┌────────────────┐    ┌──────────────┐ │   │
│  │    │ PR 번호 감지   │───►│ SWRN FTS5 검색 │───►│ 관련 문서    │ │   │
│  │    │ "PR-123456"    │    │ swrn_indexer   │    │ 3-5개 추출   │ │   │
│  │    └────────────────┘    └────────────────┘    └──────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│         │                                                               │
│         ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 2. CONTEXT BUILDING (컨텍스트 구성)                              │   │
│  │                                                                  │   │
│  │  프롬프트 = """                                                  │   │
│  │  다음 문서를 참고하여 질문에 답하세요.                           │   │
│  │                                                                  │   │
│  │  [검색된 문서]                                                   │   │
│  │  PR-123456: Root Cause - RF generator timing mismatch...        │   │
│  │  Solution - Updated synchronization logic in PMController...    │   │
│  │                                                                  │   │
│  │  질문: PR-123456의 Root Cause가 뭐야?                           │   │
│  │  """                                                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│         │                                                               │
│         ▼                                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │ 3. GENERATION (생성)                                             │   │
│  │    ┌────────────────┐    ┌────────────────────────────────────┐ │   │
│  │    │ Llama 3.2-3B   │───►│ "PR-123456의 Root Cause는 RF      │ │   │
│  │    │ (GGUF 모델)    │    │  generator의 타이밍 불일치입니다.  │ │   │
│  │    └────────────────┘    │  동기화 로직 문제로 인해..."       │ │   │
│  │                          └────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
### 5.1 GGUF 모델 로딩 구조

본 시스템은 외부 API 의존 없이 로컬에서 LLM을 구동하기 위해 `ctransformers` 라이브러리와 GGUF 포맷을 사용합니다.

#### ctransformers와 GGUF의 유기적 동작 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              ctransformers + GGUF 로컬 LLM 구동 아키텍처                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    1단계: GGUF 파일 구조                              │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │  Llama-3.2-3B-Instruct-Q4_K_M.gguf (1.88GB)                  │    │   │
│  │  │  ┌───────────────┬───────────────┬─────────────────────┐    │    │   │
│  │  │  │   Header      │   Metadata    │   Tensor Data       │    │    │   │
│  │  │  │  (Magic#)     │  (Config)     │   (양자화 가중치)    │    │    │   │
│  │  │  │               │               │                     │    │    │   │
│  │  │  │ • GGUF v3     │ • vocab_size  │ • Q4_K_M blocks     │    │    │   │
│  │  │  │ • tensor_cnt  │ • hidden_dim  │ • scale factors     │    │    │   │
│  │  │  │ • kv_count    │ • n_layers    │ • quantized weights │    │    │   │
│  │  │  └───────────────┴───────────────┴─────────────────────┘    │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                         │                                   │
│                                         ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                 2단계: ctransformers 초기화                          │   │
│  │                                                                      │   │
│  │   Python 코드:                                                       │   │
│  │   ┌────────────────────────────────────────────────────────────┐    │   │
│  │   │  from ctransformers import AutoModelForCausalLM            │    │   │
│  │   │                                                            │    │   │
│  │   │  model = AutoModelForCausalLM.from_pretrained(             │    │   │
│  │   │      "Llama-3.2-3B-Instruct-Q4_K_M.gguf",                  │    │   │
│  │   │      model_type="llama",      # 모델 아키텍처 지정          │    │   │
│  │   │      context_length=4096,     # 컨텍스트 윈도우             │    │   │
│  │   │      threads=4                # CPU 스레드 수               │    │   │
│  │   │  )                                                         │    │   │
│  │   └────────────────────────────────────────────────────────────┘    │   │
│  │                              │                                       │   │
│  │                              ▼                                       │   │
│  │   내부 처리:                                                         │   │
│  │   ┌────────────────────────────────────────────────────────────┐    │   │
│  │   │  1. GGUF 헤더 파싱 → 모델 구조 파악                        │    │   │
│  │   │  2. 메타데이터 로드 → vocab, config 설정                   │    │   │
│  │   │  3. 텐서 메모리 매핑 (mmap) → RAM 효율적 로드              │    │   │
│  │   │  4. GGML 백엔드 초기화 → CPU/GPU 연산 준비                 │    │   │
│  │   └────────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                         │                                   │
│                                         ▼                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   3단계: 추론 파이프라인                              │   │
│  │                                                                      │   │
│  │   입력: "PR-123456의 Root Cause가 뭐야?"                            │   │
│  │         │                                                            │   │
│  │         ▼                                                            │   │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐     │   │
│  │   │ Tokenizer   │───►│ Token IDs   │───►│ Embedding Lookup    │     │   │
│  │   │ (BPE)       │    │ [1, 349,    │    │ (역양자화 포함)      │     │   │
│  │   │             │    │  2891, ...] │    │                     │     │   │
│  │   └─────────────┘    └─────────────┘    └──────────┬──────────┘     │   │
│  │                                                    │                 │   │
│  │                                                    ▼                 │   │
│  │   ┌─────────────────────────────────────────────────────────────┐   │   │
│  │   │              Transformer Forward Pass                        │   │   │
│  │   │  ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐      │   │   │
│  │   │  │ Layer 1 │──►│ Layer 2 │──►│  ...    │──►│Layer 28 │      │   │   │
│  │   │  │         │   │         │   │         │   │         │      │   │   │
│  │   │  │ • Attn  │   │ • Attn  │   │         │   │ • Attn  │      │   │   │
│  │   │  │ • FFN   │   │ • FFN   │   │         │   │ • FFN   │      │   │   │
│  │   │  └─────────┘   └─────────┘   └─────────┘   └─────────┘      │   │   │
│  │   │                                                              │   │   │
│  │   │  ⚡ 각 레이어에서 Q4_K_M 역양자화 수행 (실시간)               │   │   │
│  │   │     4비트 → 16비트 복원 → 행렬 연산 → 다음 레이어            │   │   │
│  │   └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                    │                 │   │
│  │                                                    ▼                 │   │
│  │   ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐     │   │
│  │   │ Logits      │───►│ Sampling    │───►│ Detokenize          │     │   │
│  │   │ (어휘 확률) │    │ (Top-p,     │    │ Token → 텍스트      │     │   │
│  │   │             │    │  Temp)      │    │                     │     │   │
│  │   └─────────────┘    └─────────────┘    └──────────┬──────────┘     │   │
│  │                                                    │                 │   │
│  │                                                    ▼                 │   │
│  │   출력: "PR-123456의 Root Cause는 RF generator의 타이밍..."         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### ctransformers 내부 구성요소

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     ctransformers 라이브러리 구조                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Python Layer (ctransformers)                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  • AutoModelForCausalLM  - 모델 자동 로드 API                        │  │
│   │  • LLM                   - 텍스트 생성 인터페이스                    │  │
│   │  • Config                - 모델 설정 관리                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼ (Python → C++ 바인딩)                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        GGML Backend (C/C++)                          │  │
│   │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌────────────┐  │  │
│   │  │ GGUF Parser │  │ Quantization│  │ Tensor Ops  │  │ Threading  │  │  │
│   │  │             │  │ Kernels     │  │             │  │ (OpenMP)   │  │  │
│   │  │ • 파일 로드 │  │             │  │ • MatMul    │  │            │  │  │
│   │  │ • 텐서 추출 │  │ • Q4_K_M    │  │ • Softmax   │  │ • 병렬화   │  │  │
│   │  │ • mmap      │  │ • Q5_K_M    │  │ • GELU      │  │ • SIMD     │  │  │
│   │  └─────────────┘  │ • Q8_0     │  │ • RMSNorm   │  └────────────┘  │  │
│   │                   └─────────────┘  └─────────────┘                   │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                        │
│                                    ▼                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                       하드웨어 계층                                   │  │
│   │                                                                       │  │
│   │   CPU 모드 (본 시스템):                                               │  │
│   │   ├── AVX2/AVX-512 SIMD 명령어 활용                                  │  │
│   │   ├── 멀티스레드 행렬 연산 (threads=4)                               │  │
│   │   └── 메모리 대역폭 최적화 (4비트 양자화)                            │  │
│   │                                                                       │  │
│   │   (선택) GPU 모드:                                                    │  │
│   │   ├── CUDA (NVIDIA)                                                  │  │
│   │   ├── Metal (Apple Silicon)                                          │  │
│   │   └── ROCm (AMD)                                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### GGUF vs 다른 모델 포맷 비교

| 특성 | GGUF | PyTorch (.pt) | SafeTensors | ONNX |
|-----|------|---------------|-------------|------|
| **용도** | CPU 추론 최적화 | 학습/추론 | 안전한 저장 | 크로스플랫폼 |
| **양자화 내장** | ✅ Q2~Q8 | ❌ 별도 필요 | ❌ 별도 필요 | ⚠️ 제한적 |
| **mmap 지원** | ✅ 메모리 효율 | ❌ 전체 로드 | ✅ | ❌ |
| **메타데이터** | ✅ 완전 | ⚠️ 제한적 | ⚠️ 제한적 | ⚠️ 제한적 |
| **의존성** | GGML만 필요 | PyTorch 필요 | 경량 | ONNX Runtime |
| **로딩 속도** | 빠름 | 보통 | 빠름 | 보통 |
┌─────────────────────────────────────────────────────────────────┐
│                    GGUF 모델 로딩 구조                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  원본 모델 (FP16)          양자화 (Q4_K_M)        메모리 사용    │
│  ┌─────────────┐          ┌─────────────┐       ┌───────────┐  │
│  │  6GB+       │  ──────► │  1.88GB     │ ────► │ ~3GB RAM  │  │
│  │  (Full)     │          │  (4-bit)    │       │ (실행시)   │  │
│  └─────────────┘          └─────────────┘       └───────────┘  │
│                                                                 │
│  파일 경로:                                                     │
│  • 로컬: C:\Users\leeje3\.ollama\Llama-3.2-3B-Instruct-Q4_K_M.gguf
│  • 서버: C:\FlaskDashboard\app\Llama-3.2-3B-Instruct-Q4_K_M.gguf
└─────────────────────────────────────────────────────────────────┘

### 5.1.1 양자화(Quantization) 상세 설명

양자화는 신경망 모델의 가중치(weight)를 더 적은 비트로 표현하여 모델 크기를 줄이고 추론 속도를 향상시키는 기술입니다.

#### 양자화의 원리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         양자화 변환 과정                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  원본 가중치 (FP16 - 16비트 부동소수점)                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  w₁ = 0.234567890123     (16비트)                                    │   │
│  │  w₂ = -0.987654321098    (16비트)                                    │   │
│  │  w₃ = 0.567891234567     (16비트)                                    │   │
│  │  ...                                                                 │   │
│  │  3B 파라미터 × 16비트 = 약 6GB                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    Q4_K_M 양자화 과정                                 │   │
│  │                                                                       │   │
│  │  1. 가중치 범위 분석 (min/max 스케일 계산)                           │   │
│  │  2. 32개 가중치를 하나의 블록으로 그룹화                             │   │
│  │  3. 각 블록별 스케일 팩터(FP16) 저장                                 │   │
│  │  4. 가중치를 4비트 정수로 양자화                                     │   │
│  │                                                                       │   │
│  │  수식: q = round((w - min) / scale × 15)                             │   │
│  │       여기서 q ∈ {0, 1, 2, ..., 15} (4비트 = 16단계)                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  양자화된 가중치 (Q4_K_M - 4비트 + 스케일)                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  블록 1: scale=0.0234 (FP16), [7, 2, 14, 9, ...] (4비트×32)         │   │
│  │  블록 2: scale=0.0189 (FP16), [3, 11, 5, 8, ...] (4비트×32)         │   │
│  │  ...                                                                 │   │
│  │  평균: 4.5비트/파라미터 → 약 1.88GB                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 양자화 방식 비교

| 양자화 유형 | 비트/파라미터 | 모델 크기 (3B) | 품질 손실 | 사용 사례 |
|------------|--------------|----------------|----------|-----------|
| **FP16** (원본) | 16비트 | ~6GB | 없음 | GPU 서버, 최고 품질 필요 시 |
| **Q8_0** | 8비트 | ~3GB | 매우 적음 | GPU 메모리 충분할 때 |
| **Q5_K_M** | ~5.5비트 | ~2.3GB | 적음 | 품질/크기 균형 |
| **Q4_K_M** ✓ | ~4.5비트 | ~1.88GB | 약간 | **CPU 환경 권장** |
| **Q4_0** | 4비트 | ~1.7GB | 보통 | 극한 메모리 제한 |
| **Q2_K** | ~2.5비트 | ~1GB | 많음 | 임베디드 시스템 |

#### Q4_K_M이 선택된 이유

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Q4_K_M 선택 근거                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 메모리 효율성                                                           │
│     ├── 원본 6GB → 1.88GB (약 70% 감소)                                    │
│     ├── CPU RAM 3-4GB로 실행 가능                                          │
│     └── 서버/로컬 PC 모두에서 구동 가능                                    │
│                                                                             │
│  2. 품질 유지                                                               │
│     ├── K_M = "K-Quants Medium" - 중요 레이어 보존                         │
│     ├── Attention 레이어: 높은 정밀도 유지                                 │
│     ├── FFN 레이어: 공격적 양자화                                          │
│     └── Perplexity 증가 < 1% (거의 품질 손실 없음)                         │
│                                                                             │
│  3. 추론 속도                                                               │
│     ├── 4비트 정수 연산 → SIMD 가속 가능                                   │
│     ├── 메모리 대역폭 병목 감소                                            │
│     └── CPU에서도 토큰/초 10-20개 달성                                     │
│                                                                             │
│  4. 호환성                                                                  │
│     ├── GGUF 포맷: llama.cpp, ctransformers 지원                           │
│     ├── Ollama, LM Studio 등 주요 도구 호환                                │
│     └── Windows/Linux/Mac 크로스 플랫폼                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 역양자화(Dequantization) - 추론 시

```
추론 시 가중치 복원:
┌─────────────────────────────────────────────────────────────────┐
│  저장된 양자화 값: q = 7 (4비트)                                 │
│  저장된 스케일:    scale = 0.0234                               │
│  저장된 최소값:    min = -0.35                                  │
│                                                                 │
│  복원 공식: w' = min + (q / 15) × scale × range                 │
│  복원된 값: w' ≈ 0.2341 (원본 0.2346과 유사)                    │
│                                                                 │
│  ⚠️ 복원은 실시간으로 수행 (저장 공간은 4비트만 사용)            │
└─────────────────────────────────────────────────────────────────┘
```
- **모델**: Llama-3.2-3B-Instruct-Q4_K_M.gguf (약 1.88GB)
- **양자화**: 4-bit quantization (Q4_K_M)으로 메모리 사용량 최적화
- **로딩 방식**:
  ```python
  AutoModelForCausalLM.from_pretrained(
      model_path,
      model_type="llama",
      context_length=4096,  # 긴 문맥 처리를 위한 확장
      threads=4             # CPU 병렬 처리
  )
  ```
- **폴백(Fallback) 메커니즘**: GGUF 로드 실패 시 Ollama API 시도, 실패 시 규칙 기반 분석기로 자동 전환

### 5.2 질의 처리 프로세스

1. **쿼리 전처리**: 한국어 키워드를 영어로 변환 (예: "고쳐졌" → "fixed")
2. **하이브리드 검색**:
   - FTS5: 정확한 키워드 매칭 (PR 번호, 에러 코드)
   - TF-IDF: 문맥적 유사도 매칭 (코사인 유사도)
3. **프롬프트 구성**: 검색된 상위 5개 문서를 컨텍스트로 주입
4. **응답 생성**: LLM이 컨텍스트에 기반하여 답변 생성 (Hallucination 방지)

---

## 6. 도메인 특화 알고리즘

### 6.1 WHERE + WHAT 키워드 추출

반도체 장비 소프트웨어의 특성을 반영하여 PR 제목에서 핵심 정보를 추출하는 알고리즘입니다.
┌─────────────────────────────────────────────────────────────────────────┐
│                   WHERE + WHAT 키워드 추출                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  입력: "Actual process time is more progressed in Kiyo GX"             │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    패턴 매칭 단계                                 │   │
│  │                                                                   │   │
│  │  WHERE 패턴 (위치/컨텍스트)                                      │   │
│  │  ┌─────────────────────────────────────────────────────────┐    │   │
│  │  │ 장비명: Kiyo GX, Sensei, Producer GT...                 │    │   │
│  │  │ 페이지: Recipe Page, Tempo Editor...                     │    │   │
│  │  │ 모듈:   Factory Automation, UI session...               │    │   │
│  │  └─────────────────────────────────────────────────────────┘    │   │
│  │                           ↓                                      │   │
│  │                    매칭: "Kiyo GX" ✓                             │   │
│  │                                                                   │   │
│  │  WHAT 패턴 (대상/동작)                                           │   │
│  │  ┌─────────────────────────────────────────────────────────┐    │   │
│  │  │ 대상:   process time, Cancel button, SVID...            │    │   │
│  │  │ 증상:   termination, crash, mismatch...                 │    │   │
│  │  │ 동작:   Add, Remove, Update...                          │    │   │
│  │  └─────────────────────────────────────────────────────────┘    │   │
│  │                           ↓                                      │   │
│  │                    매칭: "process time" ✓                        │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  출력 키워드 (우선순위 정렬):                                           │
│  1. "Kiyo GX process time"  (WHERE + WHAT 조합) - 최고 점수            │
│  2. "process time"          (WHAT 복합어)                              │
│  3. "Kiyo GX"               (WHERE 단일)                               │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
**WHERE (위치/컨텍스트)**
- **장비명**: Kiyo GX, Sensei, Akara, Vantex
- **화면/모듈**: Recipe Page, Tempo Editor, Factory Automation
- **하드웨어**: Chamber, Loadport, Aligner

**WHAT (대상/동작)**
- **대상**: Process Time, SVID, Cancel Button, Recipe Parameter
- **증상**: Termination, Crash, Timeout, Mismatch
- **동작**: Add, Remove, Update, Fix

**예시:**
> "Actual process time is more progressed than setpoint time in Kiyo GX"
> - **WHERE**: Kiyo GX
> - **WHAT**: process time, setpoint time

### 6.2 유사 PR 검색 점수 체계

추출된 키워드를 기반으로 유사한 과거 사례를 찾을 때 적용되는 가중치 시스템입니다.
┌─────────────────────────────────────────────────────────────────────────┐
│                    유사 PR 검색 점수 체계                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  입력 PR: "RF power mismatch in Kiyo GX chamber"                       │
│  추출 키워드: ["Kiyo GX RF", "RF power", "mismatch", "chamber"]        │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    점수 계산 규칙                                 │   │
│  │                                                                   │   │
│  │  조합 키워드 (WHERE+WHAT)                                        │   │
│  │  ├── 제목에서 완전 매칭: +30점                                   │   │
│  │  ├── 내용에서 완전 매칭: +15점                                   │   │
│  │  └── 60% 이상 부분 매칭: +부분점수                               │   │
│  │                                                                   │   │
│  │  단일 키워드                                                      │   │
│  │  ├── 제목에서 매칭: +8점                                         │   │
│  │  └── 내용에서 매칭: +3점                                         │   │
│  │                                                                   │   │
│  │  완전 매칭 보너스: +10점 × 매칭 개수                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  검색 결과 예시:                                                        │
│  ┌────────────┬────────────────────────────────┬───────────┐          │
│  │ PR 번호    │ 매칭 키워드                     │ 점수      │          │
│  ├────────────┼────────────────────────────────┼───────────┤          │
│  │ PR-234567  │ "Kiyo GX RF", "mismatch"       │ 68점      │          │
│  │ PR-345678  │ "RF power", "chamber"          │ 45점      │          │
│  │ PR-456789  │ "mismatch"                      │ 18점      │          │
│  └────────────┴────────────────────────────────┴───────────┘          │
└─────────────────────────────────────────────────────────────────────────┘
| 매칭 조건 | 점수 | 설명 |
|----------|------|------|
| **조합 키워드 + 제목 매칭** | **30점** | "Kiyo GX"와 같이 구체적 조합이 제목에 포함 |
| **조합 키워드 + 내용 매칭** | **15점** | 구체적 조합이 본문에 포함 |
| **단일 키워드 + 제목 매칭** | **8점** | "Error" 같은 단일 단어가 제목에 포함 |
| **단일 키워드 + 내용 매칭** | **5점** | 단일 단어가 본문에 포함 |
| **완전 매칭 보너스** | **+10점** | 키워드 형태소 변형 없이 정확히 일치 |

---

## 7. 하이브리드 검색 엔진 기술 상세

본 시스템은 단일 검색 기술의 한계를 극복하기 위해 **다층 하이브리드 검색 아키텍처**를 채택했습니다. Sparse Retrieval(희소 검색)과 Dense Retrieval(밀집 검색)을 결합하여, 정확성과 재현율을 동시에 확보합니다.

### 7.1 하이브리드 검색 엔진 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    하이브리드 검색 엔진 아키텍처                              │
│                    (HybridPRSearchEngine)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   사용자 질의: "Kiyo GX RF power mismatch"                                  │
│         │                                                                   │
│         ▼                                                                   │
│   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│   ┃ 1단계: 동의어 확장 (Synonym Expansion)                               ┃  │
│   ┃━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┃  │
│   ┃                                                                       ┃  │
│   ┃   입력: "RF power mismatch"                                          ┃  │
│   ┃         │                                                             ┃  │
│   ┃         ▼                                                             ┃  │
│   ┃   ┌─────────────────────────────────────────────────────────────┐    ┃  │
│   ┃   │ SynonymExpander (반도체 도메인 특화)                         │    ┃  │
│   ┃   │                                                              │    ┃  │
│   ┃   │  "mismatch" → ["discrepancy", "difference", "deviation"]    │    ┃  │
│   ┃   │  "error" → ["fault", "failure", "issue", "problem"]         │    ┃  │
│   ┃   │  "rf" → ["radio frequency", "rf power", "rf generator"]     │    ┃  │
│   ┃   │  "chamber" → ["chmbr", "ch", "process chamber", "reactor"]  │    ┃  │
│   ┃   └─────────────────────────────────────────────────────────────┘    ┃  │
│   ┃         │                                                             ┃  │
│   ┃         ▼                                                             ┃  │
│   ┃   출력 (최대 5개 쿼리):                                              ┃  │
│   ┃   1. "RF power mismatch" (원본)                                      ┃  │
│   ┃   2. "RF power discrepancy"                                          ┃  │
│   ┃   3. "RF power difference"                                           ┃  │
│   ┃   4. "radio frequency power mismatch"                                ┃  │
│   ┃                                                                       ┃  │
│   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│         │                                                                   │
│         ▼                                                                   │
│   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│   ┃ 2단계: FTS5 + BM25 검색 (Sparse Retrieval)                          ┃  │
│   ┃━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┃  │
│   ┃                                                                       ┃  │
│   ┃   SQLite FTS5 전문 검색 엔진                                         ┃  │
│   ┃   ┌─────────────────────────────────────────────────────────────┐    ┃  │
│   ┃   │                                                              │    ┃  │
│   ┃   │  SELECT *, bm25(page_content) as score                      │    ┃  │
│   ┃   │  FROM page_content                                          │    ┃  │
│   ┃   │  WHERE page_content MATCH 'kiyo rf power'                   │    ┃  │
│   ┃   │  ORDER BY bm25(page_content)                                │    ┃  │
│   ┃   │  LIMIT 2000                                                 │    ┃  │
│   ┃   │                                                              │    ┃  │
│   ┃   └─────────────────────────────────────────────────────────────┘    ┃  │
│   ┃         │                                                             ┃  │
│   ┃         ▼                                                             ┃  │
│   ┃   후보 PR 500개 추출 (버전별 균등 샘플링)                            ┃  │
│   ┃                                                                       ┃  │
│   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│         │                                                                   │
│         ▼                                                                   │
│   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│   ┃ 3단계: TF-IDF 재랭킹 (Dense Reranking)                              ┃  │
│   ┃━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┃  │
│   ┃                                                                       ┃  │
│   ┃   scikit-learn TfidfVectorizer                                       ┃  │
│   ┃   ┌─────────────────────────────────────────────────────────────┐    ┃  │
│   ┃   │                                                              │    ┃  │
│   ┃   │  • Unigram + Bigram (ngram_range=(1,2))                     │    ┃  │
│   ┃   │  • 10,000 features                                          │    ┃  │
│   ┃   │  • Sublinear TF (로그 스케일)                               │    ┃  │
│   ┃   │  • Cosine Similarity 계산                                   │    ┃  │
│   ┃   │                                                              │    ┃  │
│   ┃   └─────────────────────────────────────────────────────────────┘    ┃  │
│   ┃         │                                                             ┃  │
│   ┃         ▼                                                             ┃  │
│   ┃   TF-IDF 점수로 후보 재정렬                                          ┃  │
│   ┃                                                                       ┃  │
│   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│         │                                                                   │
│         ▼                                                                   │
│   ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│   ┃ 4단계: 하이브리드 점수 계산 (Combined Scoring)                       ┃  │
│   ┃━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┃  │
│   ┃                                                                       ┃  │
│   ┃   hybrid_score = (0.4 × BM25) + (0.4 × TF-IDF) + (0.2 × Keyword)    ┃  │
│   ┃                                                                       ┃  │
│   ┃   ┌─────────────────────────────────────────────────────────────┐    ┃  │
│   ┃   │  BM25 가중치:     0.4  (Sparse - 키워드 정확도)             │    ┃  │
│   ┃   │  TF-IDF 가중치:   0.4  (Dense - 문서 유사도)                │    ┃  │
│   ┃   │  Keyword 가중치:  0.2  (도메인 키워드 매칭)                 │    ┃  │
│   ┃   └─────────────────────────────────────────────────────────────┘    ┃  │
│   ┃                                                                       ┃  │
│   ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│         │                                                                   │
│         ▼                                                                   │
│   최종 결과: 상위 5~20개 PR 반환                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 검색 기술 비교 및 선택 근거

#### 7.2.1 정보 검색 기술 분류

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    정보 검색 기술 분류 (IR Taxonomy)                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   검색 기술 스펙트럼                                  │   │
│  │                                                                       │   │
│  │   Sparse (희소)                              Dense (밀집)            │   │
│  │   ◄──────────────────────────────────────────────────────────────►   │   │
│  │                                                                       │   │
│  │   ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐   │   │
│  │   │ Boolean │  │  BM25   │  │ TF-IDF  │  │  BERT   │  │  GPT    │   │   │
│  │   │  Match  │  │ (FTS5)  │  │ Vector  │  │Embedding│  │Embedding│   │   │
│  │   └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘   │   │
│  │        │            │            │            │            │         │   │
│  │        ▼            ▼            ▼            ▼            ▼         │   │
│  │   정확 매칭     확률적       벡터 공간     의미적        생성적      │   │
│  │   (Exact)      랭킹         유사도       이해          이해         │   │
│  │                                                                       │   │
│  │   속도: 빠름 ◄─────────────────────────────────────────► 느림        │   │
│  │   정밀도: 높음 ◄───────────────────────────────────────► 가변        │   │
│  │   재현율: 낮음 ◄───────────────────────────────────────► 높음        │   │
│  │   리소스: 적음 ◄───────────────────────────────────────► 많음        │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  본 시스템 선택: BM25 (FTS5) + TF-IDF (하이브리드)                          │
│                                                                             │
│  선택 근거:                                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. 오프라인 환경 (인터넷 없음) → BERT/GPT API 사용 불가              │   │
│  │ 2. 반도체 도메인 특화 용어 → 일반 LLM 임베딩 성능 저하               │   │
│  │ 3. 24,000+ 문서, 50ms 이내 응답 → 경량 알고리즘 필수                 │   │
│  │ 4. PR 번호, 장비명 등 정확 매칭 필요 → Sparse 검색 필수              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 7.2.2 기술별 상세 비교

| 기술 | 원리 | 장점 | 단점 | 본 시스템 적용 |
|------|------|------|------|---------------|
| **BM25 (Okapi)** | 확률적 검색 모델, TF-IDF 개선형 | 빠름, 정확도 높음, SQLite 내장 | 동의어/유의어 인식 불가 | ✅ FTS5 기본 랭킹 |
| **TF-IDF** | 단어 빈도 × 역문서 빈도 | 문서 유사도 계산, 벡터 연산 | 어순/문맥 무시 | ✅ 재랭킹 엔진 |
| **BERT** | Transformer 기반 언어 모델 | 문맥 이해, 의미적 유사도 | GPU 필요, 느림 | ❌ 리소스 제약 |
| **Sentence-BERT** | BERT 문장 임베딩 특화 | 문장 단위 유사도 | 도메인 Fine-tuning 필요 | ❌ 오프라인 제약 |
| **ColBERT** | Late Interaction 검색 | 속도-정확도 균형 | 복잡한 인프라 | ❌ 구현 복잡도 |

### 7.3 BM25 알고리즘 (SQLite FTS5)

#### 7.3.1 BM25 수학적 정의

BM25 (Best Matching 25)는 확률적 정보 검색 모델로, TF-IDF를 개선한 알고리즘입니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BM25 알고리즘 수식                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                         n                                                   │
│   BM25(D,Q) = Σ  IDF(qi) × ───────────────────────────────────────────     │
│                i=1            f(qi,D) × (k1 + 1)                            │
│                           ─────────────────────────────────────────         │
│                           f(qi,D) + k1 × (1 - b + b × |D|/avgdl)           │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 변수 설명:                                                           │   │
│  │                                                                       │   │
│  │  Q = 쿼리 (예: "RF power mismatch")                                  │   │
│  │  D = 문서 (예: PR-123456의 내용)                                     │   │
│  │  qi = 쿼리의 i번째 단어                                              │   │
│  │  f(qi,D) = 단어 qi가 문서 D에 등장하는 횟수 (Term Frequency)        │   │
│  │  |D| = 문서 D의 길이 (단어 수)                                       │   │
│  │  avgdl = 전체 문서의 평균 길이                                       │   │
│  │  k1 = 단어 빈도 포화 파라미터 (보통 1.2~2.0)                        │   │
│  │  b = 문서 길이 정규화 파라미터 (보통 0.75)                          │   │
│  │                                                                       │   │
│  │  IDF(qi) = log((N - n(qi) + 0.5) / (n(qi) + 0.5))                   │   │
│  │  N = 전체 문서 수                                                    │   │
│  │  n(qi) = 단어 qi를 포함하는 문서 수                                 │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  SQLite FTS5의 BM25 구현:                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                       │   │
│  │  SELECT *, bm25(page_content) as score                               │   │
│  │  FROM page_content                                                    │   │
│  │  WHERE page_content MATCH 'rf power mismatch'                        │   │
│  │  ORDER BY bm25(page_content)  -- 음수, 작을수록 관련도 높음          │   │
│  │                                                                       │   │
│  │  ※ FTS5의 bm25()는 음수 반환: -5.0이 -1.0보다 더 관련 있음          │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 7.3.2 BM25 vs TF-IDF 비교

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       BM25 vs TF-IDF 비교                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   TF-IDF:                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  TF(t,d) × IDF(t)                                                    │  │
│   │                                                                      │  │
│   │  문제점:                                                             │  │
│   │  • TF가 무한히 증가 가능 (단어 반복 시 점수 과다)                   │  │
│   │  • 문서 길이 정규화 없음 (긴 문서 유리)                             │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   BM25:                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  TF 포화 (Saturation):                                               │  │
│   │                                                                      │  │
│   │  점수 ▲                                                             │  │
│   │       │          ────────────── BM25 (포화)                         │  │
│   │       │       ╱                                                      │  │
│   │       │     ╱                                                        │  │
│   │       │   ╱  ╱─────────────────── TF-IDF (선형)                     │  │
│   │       │ ╱  ╱                                                         │  │
│   │       │╱ ╱                                                           │  │
│   │       └───────────────────────────────► TF (단어 빈도)              │  │
│   │                                                                      │  │
│   │  개선점:                                                             │  │
│   │  • k1 파라미터로 TF 포화 제어 (과도한 반복 방지)                    │  │
│   │  • b 파라미터로 문서 길이 정규화                                    │  │
│   │  • 확률적 랭킹 이론 기반 (수학적 정당성)                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.4 TF-IDF 벡터화 및 코사인 유사도

#### 7.4.1 TF-IDF 수식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         TF-IDF 알고리즘                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   TF-IDF(t, d, D) = TF(t, d) × IDF(t, D)                                   │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ TF (Term Frequency) - 단어 빈도                                      │  │
│   │                                                                      │  │
│   │   기본:    TF(t,d) = 단어 t가 문서 d에 등장하는 횟수                 │  │
│   │                                                                      │  │
│   │   Sublinear TF (본 시스템 사용):                                     │  │
│   │   TF(t,d) = 1 + log(f(t,d))  if f(t,d) > 0                          │  │
│   │          = 0                  otherwise                              │  │
│   │                                                                      │  │
│   │   → 로그 스케일로 과도한 빈도 영향 완화                             │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ IDF (Inverse Document Frequency) - 역문서 빈도                       │  │
│   │                                                                      │  │
│   │   IDF(t,D) = log(N / df(t)) + 1                                     │  │
│   │                                                                      │  │
│   │   N = 전체 문서 수                                                   │  │
│   │   df(t) = 단어 t를 포함하는 문서 수                                 │  │
│   │                                                                      │  │
│   │   → 흔한 단어(the, is)는 낮은 IDF                                   │  │
│   │   → 희귀 단어(mismatch, endpoint)는 높은 IDF                        │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   본 시스템 TfidfVectorizer 설정:                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │  TfidfVectorizer(                                                    │  │
│   │      ngram_range=(1, 2),    # Unigram + Bigram                      │  │
│   │      max_features=10000,    # 상위 10,000개 단어만                  │  │
│   │      stop_words='english',  # 불용어 제거                           │  │
│   │      min_df=2,              # 최소 2개 문서에 등장                  │  │
│   │      max_df=0.95,           # 95% 이상 문서에 있으면 제외           │  │
│   │      sublinear_tf=True      # 로그 스케일 TF                        │  │
│   │  )                                                                   │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 7.4.2 코사인 유사도 (Cosine Similarity)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         코사인 유사도                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                        A · B           Σ(Ai × Bi)                          │
│   cos(θ) = ─────────────────── = ─────────────────────────                 │
│             ‖A‖ × ‖B‖         √Σ(Ai²) × √Σ(Bi²)                           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ 벡터 공간 모델 시각화:                                               │  │
│   │                                                                      │  │
│   │        ▲ "power"                                                    │  │
│   │        │                                                            │  │
│   │        │     ╱ Doc A: "RF power mismatch"                          │  │
│   │        │   ╱   θ = 15° → cos(θ) = 0.97 (높은 유사도)               │  │
│   │        │ ╱                                                          │  │
│   │        │╱─────────────── Query: "RF power error"                   │  │
│   │        │                                                            │  │
│   │        │                                                            │  │
│   │        │  ╲                                                         │  │
│   │        │    ╲  θ = 60° → cos(θ) = 0.50 (중간 유사도)               │  │
│   │        │      ╲                                                     │  │
│   │        │        Doc B: "Chamber temperature issue"                 │  │
│   │        └─────────────────────────────────────────────► "RF"        │  │
│   │                                                                      │  │
│   │   cos(θ) ∈ [0, 1]  (TF-IDF 벡터는 항상 양수)                        │  │
│   │   1.0 = 완전 일치, 0.0 = 완전 무관                                  │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   Python 구현:                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │  from sklearn.metrics.pairwise import cosine_similarity             │  │
│   │                                                                      │  │
│   │  query_vec = vectorizer.transform([query])                          │  │
│   │  similarities = cosine_similarity(query_vec, pr_vectors).flatten()  │  │
│   │                                                                      │  │
│   │  # 상위 k개 결과                                                     │  │
│   │  top_indices = np.argsort(similarities)[-k:][::-1]                  │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.5 BERT/Dense Retrieval과의 비교 (미사용 기술 참고)

#### 7.5.1 BERT 임베딩 원리

```
┌─────────────────────────────────────────────────────────────────────────────┐
│           BERT 기반 Dense Retrieval (참고 - 본 시스템 미사용)                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   BERT (Bidirectional Encoder Representations from Transformers)           │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   입력: "RF power mismatch in chamber"                              │  │
│   │         │                                                           │  │
│   │         ▼                                                           │  │
│   │   ┌─────────────────────────────────────────────────────────────┐   │  │
│   │   │              BERT Transformer (12 layers)                    │   │  │
│   │   │                                                              │   │  │
│   │   │   [CLS] RF power mismatch in chamber [SEP]                  │   │  │
│   │   │     │    │    │      │     │    │      │                    │   │  │
│   │   │     ▼    ▼    ▼      ▼     ▼    ▼      ▼                    │   │  │
│   │   │   Self-Attention (양방향 문맥 학습)                          │   │  │
│   │   │     │                                                        │   │  │
│   │   │     ▼                                                        │   │  │
│   │   │   768차원 벡터 (dense embedding)                            │   │  │
│   │   └─────────────────────────────────────────────────────────────┘   │  │
│   │         │                                                           │  │
│   │         ▼                                                           │  │
│   │   출력: [0.123, -0.456, 0.789, ..., 0.234]  (768 dimensions)       │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   장점:                                                                     │
│   • 문맥 이해: "bank" → 은행 vs 강둑 구분                                  │
│   • 동의어 자동 인식: "error" ≈ "fault" ≈ "issue"                         │
│   • 의미적 유사도: "RF 전력 불일치" ≈ "무선주파수 파워 미스매치"          │
│                                                                             │
│   본 시스템에서 미사용 이유:                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ ❌ GPU 필수: BERT 추론에 CUDA/GPU 필요                              │  │
│   │ ❌ 느린 속도: 문서당 50-100ms (24,000문서 → 20분+)                  │  │
│   │ ❌ 대용량 모델: bert-base 420MB, bert-large 1.3GB                   │  │
│   │ ❌ 도메인 미스매치: 반도체 용어 사전학습 부족                       │  │
│   │ ❌ 오프라인 제약: 일부 BERT 서비스는 API 기반                       │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 7.5.2 Dense vs Sparse Retrieval 성능 비교

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Dense vs Sparse Retrieval 비교                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                        성능 비교표                                 │    │
│   ├─────────────────┬──────────────────┬──────────────────────────────┤    │
│   │ 항목             │ Sparse (BM25)    │ Dense (BERT)                 │    │
│   ├─────────────────┼──────────────────┼──────────────────────────────┤    │
│   │ 쿼리 속도        │ <10ms           │ 50-100ms (GPU)               │    │
│   │ 인덱스 크기      │ ~200MB          │ ~2GB (768d × 24k docs)       │    │
│   │ 정확 키워드 매칭 │ ✅ 우수         │ ⚠️ 가끔 누락                 │    │
│   │ 동의어 처리      │ ❌ 수동 사전    │ ✅ 자동                      │    │
│   │ 문맥 이해        │ ❌ 없음         │ ✅ 우수                      │    │
│   │ 오프라인 가용    │ ✅ 완전 지원    │ ⚠️ 모델 다운로드 필요        │    │
│   │ 하드웨어 요구    │ CPU만 필요      │ GPU 권장                     │    │
│   └─────────────────┴──────────────────┴──────────────────────────────┘    │
│                                                                             │
│   본 시스템의 선택: Sparse (BM25) + TF-IDF 하이브리드                       │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ 하이브리드 접근법의 장점:                                            │  │
│   │                                                                      │  │
│   │ 1. BM25로 빠른 후보 추출 (10ms 이내)                                │  │
│   │ 2. TF-IDF로 후보 재랭킹 (정밀도 향상)                               │  │
│   │ 3. 동의어 사전으로 Dense의 일부 장점 확보                           │  │
│   │ 4. 완전 오프라인 동작 (보안 환경)                                   │  │
│   │                                                                      │  │
│   │ → Sparse의 속도 + Dense의 일부 정확도                               │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.6 하이브리드 점수 계산 공식

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       하이브리드 점수 계산                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   hybrid_score = α × BM25_norm + β × TF-IDF_score + γ × Keyword_score      │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ 가중치 설정:                                                         │  │
│   │                                                                      │  │
│   │   α (BM25 가중치)    = 0.4                                          │  │
│   │   β (TF-IDF 가중치)  = 0.4                                          │  │
│   │   γ (Keyword 가중치) = 0.2                                          │  │
│   │                                                                      │  │
│   │   α + β + γ = 1.0                                                   │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │ 점수 정규화:                                                         │  │
│   │                                                                      │  │
│   │   BM25_norm = (BM25_score - min) / (max - min)                      │  │
│   │   → FTS5의 음수 BM25를 0~1 범위로 정규화                            │  │
│   │                                                                      │  │
│   │   TF-IDF_score = cosine_similarity(query, document)                 │  │
│   │   → 이미 0~1 범위                                                   │  │
│   │                                                                      │  │
│   │   Keyword_score = matched_keywords / total_keywords                 │  │
│   │   → 필수 키워드 매칭 비율 (0~1)                                     │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│   예시 계산:                                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   쿼리: "Kiyo GX RF power mismatch"                                 │  │
│   │   PR-234567:                                                        │  │
│   │     • BM25_norm = 0.85                                              │  │
│   │     • TF-IDF = 0.72                                                 │  │
│   │     • Keyword (3/4 매칭) = 0.75                                     │  │
│   │                                                                      │  │
│   │   hybrid = 0.4×0.85 + 0.4×0.72 + 0.2×0.75                          │  │
│   │         = 0.34 + 0.288 + 0.15                                       │  │
│   │         = 0.778                                                     │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.7 키워드 검색 Phrase Match 시스템

사용자가 "Bias RF"를 검색했을 때, "Bias"와 "RF"가 개별적으로 있는 PR보다 "Bias RF"가 함께 있는 PR을 우선 표시합니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Phrase Match 점수 계산 알고리즘                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  검색어: "bias rf"                                                          │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    점수 계산 우선순위                                 │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐     │   │
│  │  │ 검사 순서 1: Affected Function 필드                          │     │   │
│  │  │                                                               │     │   │
│  │  │   PR-185558                                                   │     │   │
│  │  │   Affected Function: "Bias RF"                                │     │   │
│  │  │                        ^^^^^^^^                               │     │   │
│  │  │   "bias rf" ∈ "bias rf" → ✅ 정확한 phrase 매칭               │     │   │
│  │  │                                                               │     │   │
│  │  │   점수: 2000점 (최고 우선순위)                                │     │   │
│  │  └─────────────────────────────────────────────────────────────┘     │   │
│  │                            │                                         │   │
│  │                            ▼ (매칭 실패 시)                          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐     │   │
│  │  │ 검사 순서 2: Title 필드                                       │     │   │
│  │  │                                                               │     │   │
│  │  │   PR-005204                                                   │     │   │
│  │  │   Title: "The Bias RF Reflected Power setpoint..."           │     │   │
│  │  │               ^^^^^^^^                                        │     │   │
│  │  │   "bias rf" ∈ "the bias rf reflected..." → ✅                 │     │   │
│  │  │                                                               │     │   │
│  │  │   점수: 1500점                                                │     │   │
│  │  └─────────────────────────────────────────────────────────────┘     │   │
│  │                            │                                         │   │
│  │                            ▼ (매칭 실패 시)                          │   │
│  │  ┌─────────────────────────────────────────────────────────────┐     │   │
│  │  │ 검사 순서 3: 기타 필드 (Issue Description, Solution, Context) │     │   │
│  │  │                                                               │     │   │
│  │  │   PR-163915                                                   │     │   │
│  │  │   Context: "...Setpoint for Bias RF State 5 frequency..."    │     │   │
│  │  │                          ^^^^^^^^                             │     │   │
│  │  │   "bias rf" ∈ context → ✅                                    │     │   │
│  │  │                                                               │     │   │
│  │  │   점수: 1000점                                                │     │   │
│  │  └─────────────────────────────────────────────────────────────┘     │   │
│  │                            │                                         │   │
│  │                            ▼ (phrase 매칭 실패 시)                   │   │
│  │  ┌─────────────────────────────────────────────────────────────┐     │   │
│  │  │ 검사 순서 4: 모든 단어 포함 (비-phrase)                        │     │   │
│  │  │                                                               │     │   │
│  │  │   PR-183053                                                   │     │   │
│  │  │   Affected Function: "RF Bias Control"                        │     │   │
│  │  │                       ^^     ^^^^                             │     │   │
│  │  │   "rf" ✓ AND "bias" ✓ (하지만 "bias rf" 순서 아님)           │     │   │
│  │  │                                                               │     │   │
│  │  │   점수: 800점 (Affected Function) 또는 500점 (기타)          │     │   │
│  │  └─────────────────────────────────────────────────────────────┘     │   │
│  │                            │                                         │   │
│  │                            ▼ (모든 단어 없음)                        │   │
│  │  ┌─────────────────────────────────────────────────────────────┐     │   │
│  │  │ 검사 순서 5: 부분 매칭                                         │     │   │
│  │  │                                                               │     │   │
│  │  │   PR-999999                                                   │     │   │
│  │  │   Title: "RF Generator Configuration"                         │     │   │
│  │  │          ^^                                                   │     │   │
│  │  │   "rf" ✓ BUT "bias" ✗                                        │     │   │
│  │  │                                                               │     │   │
│  │  │   점수: 매칭된 단어 수 × 100 = 100점                          │     │   │
│  │  └─────────────────────────────────────────────────────────────┘     │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**점수 체계 요약 테이블:**

| 우선순위 | 매칭 조건 | 점수 | 예시 |
|---------|----------|------|------|
| 1 | Affected Function에서 phrase 정확 매칭 | **2000점** | "Bias RF" → "Bias RF" |
| 2 | Title에서 phrase 정확 매칭 | **1500점** | "Bias RF" → "The Bias RF Reflected..." |
| 3 | 기타 필드에서 phrase 정확 매칭 | **1000점** | "Bias RF" → Context 내 발견 |
| 4 | Affected Function에 모든 단어 포함 | **800점** | "RF Bias Control" (순서 다름) |
| 5 | 전체 텍스트에 모든 단어 포함 | **500점** | 여러 필드에 분산 |
| 6 | 부분 매칭 (일부 단어만) | **100~300점** | 2단어 중 1개만 매칭 시 100점 |

### 7.4 FTS5 직접 검색 전략

기존 TF-IDF 기반 하이브리드 엔진이 특정 키워드 조합을 놓치는 문제를 해결하기 위해, SQLite FTS5 직접 검색을 추가했습니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        FTS5 직접 검색 전략                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  문제 상황:                                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 기존 하이브리드 엔진 (TF-IDF + 유사도)                               │   │
│  │                                                                       │   │
│  │   검색어: "bias rf"                                                  │   │
│  │                                                                       │   │
│  │   find_similar_prs("bias rf", limit=20)                              │   │
│  │          │                                                           │   │
│  │          ▼                                                           │   │
│  │   결과: ❌ "bias"와 "rf"를 함께 포함한 PR 누락!                      │   │
│  │                                                                       │   │
│  │   원인: TF-IDF는 문서 전체 유사도 기반으로,                          │   │
│  │         특정 단어 조합의 정확한 존재 여부 검증에 약함                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  해결책: FTS5 직접 검색                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                       │   │
│  │  Step 1: AND 쿼리 시도                                               │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │ fts_query = "bias AND rf"                                      │   │   │
│  │  │                                                                │   │   │
│  │  │ SELECT DISTINCT pr_number                                      │   │   │
│  │  │ FROM page_content                                              │   │   │
│  │  │ WHERE page_content MATCH 'bias AND rf'                         │   │   │
│  │  │                                                                │   │   │
│  │  │ → 두 단어가 모두 포함된 페이지의 PR들만 반환                   │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  │         │                                                           │   │
│  │         ▼ (결과가 10개 미만이면)                                    │   │
│  │  Step 2: OR 쿼리로 폴백                                             │   │
│  │  ┌───────────────────────────────────────────────────────────────┐   │   │
│  │  │ fts_query = "bias OR rf"                                       │   │   │
│  │  │                                                                │   │   │
│  │  │ SELECT DISTINCT pr_number                                      │   │   │
│  │  │ FROM page_content                                              │   │   │
│  │  │ WHERE page_content MATCH 'bias OR rf'                          │   │   │
│  │  │                                                                │   │   │
│  │  │ → 어느 한 단어라도 포함된 페이지의 PR들 반환                   │   │   │
│  │  └───────────────────────────────────────────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  데이터베이스 스키마:                                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                       │   │
│  │  ┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐ │   │
│  │  │   pdf_files     │     │  page_content   │     │    pr_index     │ │   │
│  │  ├─────────────────┤     ├─────────────────┤     ├─────────────────┤ │   │
│  │  │ id (PK)         │◄────│ file_id (FK)    │     │ pr_number       │ │   │
│  │  │ filename        │     │ page_num        │────►│ file_id         │ │   │
│  │  │ sw_version      │     │ content (FTS5)  │     │ page_num        │ │   │
│  │  │ total_pages     │     │ rank (자동)     │     │ context         │ │   │
│  │  └─────────────────┘     └─────────────────┘     └─────────────────┘ │   │
│  │                                                                       │   │
│  │  page_content 테이블은 FTS5 가상 테이블:                              │   │
│  │  CREATE VIRTUAL TABLE page_content USING fts5(                        │   │
│  │      file_id, page_num, content,                                      │   │
│  │      tokenize="unicode61"                                             │   │
│  │  );                                                                   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.5 최종 정렬 알고리즘

검색된 PR들은 다중 기준으로 정렬됩니다.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          최종 정렬 알고리즘                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  정렬 기준 (우선순위 순):                                                    │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                       │   │
│  │  1차 정렬: Phrase Match 점수 (내림차순)                              │   │
│  │  ─────────────────────────────────────────────                       │   │
│  │                                                                       │   │
│  │  PR-185558  phrase_score=2000  ──┐                                   │   │
│  │  PR-195730  phrase_score=2000  ──┤ 동점                              │   │
│  │  PR-160963  phrase_score=2000  ──┘                                   │   │
│  │  PR-183053  phrase_score=800   ──► 4위                               │   │
│  │  PR-163915  phrase_score=1000  ──► 위 그룹보다 아래                  │   │
│  │                                                                       │   │
│  │  ┌─────────────────────────────────────────────────────────────┐     │   │
│  │  │ 동점일 때 → 2차 정렬 적용                                   │     │   │
│  │  └─────────────────────────────────────────────────────────────┘     │   │
│  │                                                                       │   │
│  │  2차 정렬: SW 버전 (내림차순)                                        │   │
│  │  ─────────────────────────────────────────────                       │   │
│  │                                                                       │   │
│  │  동점 그룹 (phrase_score=2000):                                      │   │
│  │  ┌────────────┬────────────────────────┬─────────────────────────┐   │   │
│  │  │ PR 번호    │ SW Version             │ 튜플                     │   │   │
│  │  ├────────────┼────────────────────────┼─────────────────────────┤   │   │
│  │  │ PR-185558  │ 1.8.4-SP34-Release     │ (1,8,4,34,0) → 1위      │   │   │
│  │  │ PR-195730  │ 1.8.4-SP34-Release     │ (1,8,4,34,0) → 2위      │   │   │
│  │  │ PR-160963  │ 1.8.4-SP32-Release     │ (1,8,4,32,0) → 3위      │   │   │
│  │  └────────────┴────────────────────────┴─────────────────────────┘   │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  Python 구현:                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                                                                       │   │
│  │  def get_sort_key(pr):                                               │   │
│  │      phrase_score = pr.get("phrase_match_score", 0)                  │   │
│  │      ver_tuple = parse_sw_version(pr.get("sw_version", ""))          │   │
│  │                                                                       │   │
│  │      # 튜플의 각 요소를 음수로 변환하여 내림차순 정렬                │   │
│  │      return (-phrase_score, tuple(-v for v in ver_tuple))            │   │
│  │                                                                       │   │
│  │  # 정렬 실행                                                         │   │
│  │  similar_prs.sort(key=get_sort_key)                                  │   │
│  │                                                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.6 검색 결과 예시

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   "Bias RF" 검색 결과 예시                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  검색어: "bias rf"                                                          │
│  FTS5 매칭: 50+ PRs                                                         │
│  표시 결과: 상위 20개                                                        │
│                                                                             │
│  ┌────┬───────────┬─────────────────────────┬─────────────────────────────┐ │
│  │ # │ PR 번호   │ SW Version              │ Affected Function           │ │
│  ├────┼───────────┼─────────────────────────┼─────────────────────────────┤ │
│  │ 1  │ PR-185558 │ 1.8.4-SP34-Release      │ Bias RF ✅                  │ │
│  │ 2  │ PR-195730 │ 1.8.4-SP34-Release      │ Bias RF ✅                  │ │
│  │ 3  │ PR-160963 │ 1.8.4-SP32-Release      │ Bias RF Generator ✅        │ │
│  │ 4  │ PR-111524 │ 1.8.4-SP30-Release      │ Bias RF Frequency ✅        │ │
│  │ 5  │ PR-103448 │ 1.8.4-SP29-Release      │ Bias RF Preset Power ✅     │ │
│  │ 6  │ PR-183053 │ 1.8.4-SP34-Release      │ RF Bias Control ⚠️          │ │
│  │ 7  │ PR-159338 │ 1.8.4-SP33-Release      │ -                           │ │
│  │ 8  │ PR-143145 │ 1.8.4-SP30-Release      │ CVs                         │ │
│  │    │ ...       │ ...                     │ ...                         │ │
│  └────┴───────────┴─────────────────────────┴─────────────────────────────┘ │
│                                                                             │
│  ✅ = Affected Function에서 "Bias RF" phrase 정확 매칭 (2000점)             │
│  ⚠️ = 모든 단어 포함하지만 순서가 다름 (800점)                              │
│  (없음) = 기타 필드에서 매칭 또는 부분 매칭                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.8 시스템 성능 특성

| 측정 항목 | 수치 | 비고 |
|----------|------|------|
| **BM25 검색 속도** | ~10ms | FTS5 인덱스 쿼리 |
| **TF-IDF 재랭킹** | ~30ms | 500개 후보 문서 기준 |
| **FTS5 검색 속도** | ~50ms | 100개 페이지 검색 기준 |
| **PR 상세 조회** | ~30ms/PR | PyMuPDF 페이지 파싱 포함 |
| **전체 검색 응답** | <1초 | 20개 결과 반환 기준 |
| **인덱싱된 PR 수** | 24,000+ | 415개 PDF 파일 |
| **데이터베이스 크기** | ~200MB | FTS5 인덱스 포함 |
| **하이브리드 점수 계산** | ~5ms | 3개 점수 결합 |

---

## 8. 검색 기능별 상세 아키텍처

본 시스템은 5가지 핵심 검색 기능을 제공합니다. 각 기능은 서로 다른 데이터 소스와 알고리즘을 조합하여 최적의 결과를 제공합니다.

### 8.1 검색 기능 요약

| 검색 유형 | 입력 예시 | 데이터 소스 | 핵심 기술 | 출력 |
|-----------|----------|-------------|-----------|------|
| **PR Search** | "PR-200000" | SWRN SQLite FTS5 | 직접 인덱스 조회 | PR 상세 정보 카드 |
| **Search for PR** | "Bias RF 관련 PR 찾아줘" | SWRN SQLite FTS5 | FTS5 AND 검색 + Phrase Match | PR 목록 테이블 |
| **Search for Keyword** | "Bias RF 관련 설명해줘" | CSV/Excel + TF-IDF | TF-IDF 벡터 검색 + LLM | AI 설명 + 관련 데이터 |
| **SWRN Compare** | "SP33-HF15 vs SP33-HF16 비교" | SWRN pr_index | 버전 범위 쿼리 + Delta 계산 | Delta Summary 리포트 |
| **SWRN PR Extract** | "SP33-HF16에 추가된 PR 알려줘" | SWRN pr_index | 버전 파싱 + 이전버전 자동계산 | 신규 PR 목록 |

---

### 8.2 PR Search (직접 PR 번호 검색)

**사용법**: `PR-200000` (PR 번호만 입력)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PR Search 처리 흐름                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  사용자 입력: "PR-200000" 또는 "200000"                                     │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1단계: 쿼리 분석 (local_rag.py → _check_pr_query())                 │   │
│  │    • 정규식 패턴: r'PR[-\s]?(\d{6})' 또는 r'(\d{6})'                │   │
│  │    • PR 번호 추출 및 정규화: "200000" → "PR-200000"                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2단계: SQLite FTS5 인덱스 조회 (swrn_indexer.py → search_pr())      │   │
│  │                                                                      │   │
│  │    SELECT p.pr_number, f.filename, f.sw_version, p.page_num,        │   │
│  │           p.context, p.pr_type                                       │   │
│  │    FROM pr_index p                                                   │   │
│  │    JOIN pdf_files f ON p.file_id = f.id                             │   │
│  │    WHERE p.pr_number = 'PR-200000'                                  │   │
│  │                                                                      │   │
│  │    ⏱️ 검색 시간: ~10ms (인덱스 직접 조회)                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3단계: PDF 상세 정보 추출 (swrn_indexer.py → get_pr_detail())       │   │
│  │                                                                      │   │
│  │    • PyMuPDF로 PDF 파일 열기                                        │   │
│  │    • 해당 페이지 + 다음 페이지들 텍스트 추출 (최대 5페이지)          │   │
│  │    • 정규식으로 필드 파싱:                                           │   │
│  │      - Component, Module, Affected Function                         │   │
│  │      - Issue Description / Benefits                                 │   │
│  │      - Root Cause, Solution, History                                │   │
│  │      - CV(Configurable Variable)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4단계: HTML 카드 렌더링 (swrn_indexer.py → format_pr_result())      │   │
│  │                                                                      │   │
│  │    ┌───────────────────────────────────────────────────────────┐    │   │
│  │    │ 📋 PR-200000 (Issue Fix)                                  │    │   │
│  │    │ SW Version: 1.8.4-SP34-HF2-Release                       │    │   │
│  │    │ ─────────────────────────────────────────────────────────│    │   │
│  │    │ Component: Etch | Module: RF Control                      │    │   │
│  │    │ Affected Function: Bias RF Power                          │    │   │
│  │    │ ─────────────────────────────────────────────────────────│    │   │
│  │    │ Issue: RF power mismatch during...                        │    │   │
│  │    │ Root Cause: Timing synchronization error...               │    │   │
│  │    │ Solution: Updated PMController logic...                   │    │   │
│  │    │ ─────────────────────────────────────────────────────────│    │   │
│  │    │ 🔗 [iPLM Link] [All Versions: SP34-HF2, SP34-HF1, ...]    │    │   │
│  │    └───────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**데이터 흐름**:
1. `local_rag.py` → `_check_pr_query()` - 정규식으로 PR 번호 추출
2. `swrn_indexer.py` → `search_pr()` - SQLite pr_index 테이블 조회
3. `swrn_indexer.py` → `get_pr_detail()` - PyMuPDF로 PDF 상세 파싱
4. `swrn_indexer.py` → `format_pr_result()` - HTML 카드 생성

**사용 기술**:
- SQLite FTS5 인덱스 (pr_index 테이블)
- PyMuPDF (fitz) PDF 텍스트 추출
- 정규식 기반 필드 파싱

---

### 8.3 Search for PR (키워드 기반 PR 검색)

**사용법**: `Bias RF 관련 PR 찾아줘`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Search for PR 처리 흐름                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  사용자 입력: "Bias RF 관련 PR 찾아줘"                                      │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1단계: 키워드 PR 검색 패턴 감지 (local_rag.py)                       │   │
│  │                                                                      │   │
│  │    패턴 매칭: r'(.+?)\s*관련\s*(?:PR|피알)\s*(?:찾아|검색)?'         │   │
│  │    → 키워드 추출: "Bias RF"                                          │   │
│  │                                                                      │   │
│  │    지원 패턴:                                                        │   │
│  │    • "Bias RF 관련 PR 찾아줘" (한국어)                               │   │
│  │    • "Bias RF에 대한 PR" (한국어)                                    │   │
│  │    • "find PRs related to Bias RF" (영어)                           │   │
│  │    • "Bias RF PR" (단순형)                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2단계: FTS5 AND 검색 (local_rag.py → _keyword_pr_search())          │   │
│  │                                                                      │   │
│  │    키워드 토큰화: ["bias", "rf"]                                     │   │
│  │    FTS5 쿼리: "bias AND rf"                                         │   │
│  │                                                                      │   │
│  │    SELECT DISTINCT f.filename, pc.page_num, f.sw_version            │   │
│  │    FROM page_content pc                                              │   │
│  │    JOIN pdf_files f ON CAST(pc.file_id AS INTEGER) = f.id           │   │
│  │    WHERE page_content MATCH 'bias AND rf'                           │   │
│  │    ORDER BY rank                                                     │   │
│  │    LIMIT 100                                                         │   │
│  │                                                                      │   │
│  │    ⏱️ FTS5 검색: ~50ms (BM25 랭킹 포함)                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3단계: 해당 페이지의 PR 번호 추출                                    │   │
│  │                                                                      │   │
│  │    각 페이지에서 PR 번호 찾기:                                       │   │
│  │    SELECT DISTINCT p.pr_number                                       │   │
│  │    FROM pr_index p                                                   │   │
│  │    JOIN pdf_files f ON p.file_id = f.id                             │   │
│  │    WHERE f.filename = ? AND p.page_num = ?                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4단계: PR 상세 정보 + Phrase Match 점수 계산                         │   │
│  │                                                                      │   │
│  │    각 PR에 대해:                                                     │   │
│  │    • get_pr_detail() → Affected Function, Title, Description 추출   │   │
│  │    • Phrase Match 점수 계산:                                         │   │
│  │                                                                      │   │
│  │    ┌─────────────────────────────────────────────────────────────┐  │   │
│  │    │  Phrase Match 점수 체계                                      │  │   │
│  │    │  ─────────────────────────────────────────────────────────  │  │   │
│  │    │  2000점: Affected Function에서 "Bias RF" 정확 매칭          │  │   │
│  │    │  1500점: Title에서 "Bias RF" 정확 매칭                      │  │   │
│  │    │  1000점: 기타 필드에서 "Bias RF" 정확 매칭                  │  │   │
│  │    │   800점: Affected Function에 모든 단어 포함 (순서 무관)     │  │   │
│  │    │   500점: 전체 텍스트에 모든 단어 포함                       │  │   │
│  │    └─────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 5단계: 정렬 및 HTML 테이블 생성                                      │   │
│  │                                                                      │   │
│  │    정렬 기준: (Phrase Match 점수 내림차순, SW Version 내림차순)      │   │
│  │                                                                      │   │
│  │    ┌────────────────────────────────────────────────────────────┐   │   │
│  │    │ 🔍 'Bias RF' 검색 결과 (25건)                              │   │   │
│  │    │ ───────────────────────────────────────────────────────── │   │   │
│  │    │ PR번호    | SW Version | Affected Function | Description  │   │   │
│  │    │ PR-185558 | SP34-HF2   | Bias RF ✅        | Power sync..│   │   │
│  │    │ PR-195730 | SP34-HF1   | Bias RF ✅        | Timing fix..│   │   │
│  │    │ PR-160963 | SP32-HF5   | RF Bias Control ⚠️| Generator...│   │   │
│  │    │ ...                                                        │   │   │
│  │    └────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**핵심 알고리즘: Phrase Match 점수 시스템**

```python
def calculate_phrase_match_score(keyword, pr_detail):
    original_keyword_lower = keyword.lower()
    keyword_words = keyword.lower().split()
    
    affected_func = pr_detail.get("affected_function", "").lower()
    title = pr_detail.get("title", "").lower()
    other_text = pr_detail.get("description", "").lower()
    
    # 1) Affected Function에서 정확한 구문 매칭 (최고 점수)
    if original_keyword_lower in affected_func:
        return 2000
    # 2) Title에서 정확한 구문 매칭
    elif original_keyword_lower in title:
        return 1500
    # 3) 기타 필드에서 정확한 구문 매칭
    elif original_keyword_lower in other_text:
        return 1000
    # 4) Affected Function에 모든 단어 포함 (순서 무관)
    elif all(w in affected_func for w in keyword_words):
        return 800
    # 5) 전체 텍스트에 모든 단어 포함
    elif all(w in f"{affected_func} {title} {other_text}" for w in keyword_words):
        return 500
    else:
        return 0
```

---

### 8.4 Search for Keyword (키워드 설명 검색)

**사용법**: `Bias RF 관련 설명해줘`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Search for Keyword 처리 흐름                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  사용자 입력: "Bias RF 관련 설명해줘"                                       │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1단계: 설명 모드 감지 (local_rag.py → rag_query())                   │   │
│  │                                                                      │   │
│  │    설명 키워드 감지: ['설명', '알려줘', 'explain', 'what is', ...]   │   │
│  │    → PR 검색 키워드 ('PR', '찾아줘') 없음 확인                       │   │
│  │    → 설명 모드 진입                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2단계: 쿼리 전처리 및 확장 (local_rag.py)                            │   │
│  │                                                                      │   │
│  │    • 한국어→영어 번역: _translate_korean_keywords()                  │   │
│  │      "바이어스" → "Bias"                                             │   │
│  │      "고주파" → "RF Radio Frequency"                                 │   │
│  │                                                                      │   │
│  │    • 동의어 확장: expand_query()                                     │   │
│  │      "Bias RF" → "Bias RF radio frequency 바이어스 고주파"           │   │
│  │                                                                      │   │
│  │    • 불용어 제거: 관련, 설명, 해줘, the, a, an...                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3단계: TF-IDF 벡터 검색 (local_rag.py → search())                    │   │
│  │                                                                      │   │
│  │    데이터 소스: CSV/Excel 파일들 (TF-IDF 인덱스)                     │   │
│  │    • Issues Tracking.csv                                             │   │
│  │    • SW_IB_Version.csv                                               │   │
│  │    • Ticket Details.xlsx                                             │   │
│  │    • FiF Sw Upgrade Plan.xlsx                                        │   │
│  │                                                                      │   │
│  │    ┌─────────────────────────────────────────────────────────────┐  │   │
│  │    │  TF-IDF 검색 알고리즘                                        │  │   │
│  │    │  ─────────────────────────────────────────────────────────  │  │   │
│  │    │  1. 쿼리 벡터화: vectorizer.transform([query])              │  │   │
│  │    │  2. 코사인 유사도: cosine_similarity(query_vec, doc_matrix) │  │   │
│  │    │  3. 상위 K개 선택 (K=10)                                    │  │   │
│  │    │  4. AND 필터: 원본 쿼리 토큰 50% 이상 매칭 필수             │  │   │
│  │    └─────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │    ⏱️ TF-IDF 검색: ~30ms                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4단계: LLM 응답 생성 (local_rag.py → _generate_explanation())       │   │
│  │                                                                      │   │
│  │    ┌─────────────────────────────────────────────────────────────┐  │   │
│  │    │  Ollama API 호출 (llama3.2-local)                           │  │   │
│  │    │  ─────────────────────────────────────────────────────────  │  │   │
│  │    │  POST http://localhost:11434/api/generate                   │  │   │
│  │    │                                                              │  │   │
│  │    │  프롬프트 구성:                                              │  │   │
│  │    │  [System Prompt] K-Bot 페르소나                              │  │   │
│  │    │  [Context] TF-IDF 검색 결과 문서들                          │  │   │
│  │    │  [Question] "Bias RF에 대해 설명해주세요"                    │  │   │
│  │    │                                                              │  │   │
│  │    │  생성 옵션:                                                  │  │   │
│  │    │  temperature=0.75, top_p=0.92, num_predict=1500             │  │   │
│  │    └─────────────────────────────────────────────────────────────┘  │   │
│  │                                                                      │   │
│  │    ⏱️ LLM 응답: 2-5초 (Llama 3.2-3B GGUF)                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 5단계: HTML 응답 포맷팅                                              │   │
│  │                                                                      │   │
│  │    ┌───────────────────────────────────────────────────────────┐    │   │
│  │    │ 🤖 K-Bot Says:                                            │    │   │
│  │    │ ──────────────────────────────────────────────────────── │    │   │
│  │    │ Bias RF에 대해 설명드릴게요! 😊                           │    │   │
│  │    │                                                           │    │   │
│  │    │ **Bias RF**는 플라즈마 에칭 장비에서 웨이퍼에 인가되는    │    │   │
│  │    │ 고주파(Radio Frequency) 전력입니다...                     │    │   │
│  │    │                                                           │    │   │
│  │    │ 📚 관련 이슈 (최근 3개월):                                 │    │   │
│  │    │ • Issue #123: Bias RF 불안정 - SP34 해결                  │    │   │
│  │    │ • Issue #456: RF Power 미스매치 - Waiting                 │    │   │
│  │    │ ──────────────────────────────────────────────────────── │    │   │
│  │    │ 🔒 완전 로컬 처리 | TF-IDF 기반 검색                      │    │   │
│  │    └───────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**Search for PR vs Search for Keyword 차이점**:

| 구분 | Search for PR | Search for Keyword |
|------|--------------|-------------------|
| **트리거** | "PR 찾아줘", "find PR" | "설명해줘", "explain" |
| **데이터 소스** | SWRN PDF (SQLite FTS5) | CSV/Excel (TF-IDF) |
| **출력 형식** | PR 목록 테이블 | AI 설명 + 관련 데이터 |
| **LLM 사용** | ❌ | ✅ Ollama Llama 3.2 |

---

### 8.5 SWRN Compare (버전 비교)

**사용법**: `SP33-HF15 vs SP33-HF16 비교`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       SWRN Compare 처리 흐름                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  사용자 입력: "SP33-HF15 vs SP33-HF16 비교"                                 │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1단계: 버전 범위 패턴 감지 (local_rag.py → _check_version_range())   │   │
│  │                                                                      │   │
│  │    버전 패턴: r'(?:1\.8\.4[- ]?)?(SP\d+)(?:[- ]?(HF\d+|Release))?'  │   │
│  │                                                                      │   │
│  │    추출 결과:                                                        │   │
│  │    • version_from: "1.8.4-SP33-HF15"                                 │   │
│  │    • version_to: "1.8.4-SP33-HF16"                                   │   │
│  │                                                                      │   │
│  │    ★ 타이포 자동 수정:                                               │   │
│  │    • "P33-HF16" → "SP33-HF16" (S 누락 수정)                         │   │
│  │    • "SP33-HG16" → "SP33-HF16" (G→F 수정)                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2단계: 버전 튜플 변환 및 정렬 (swrn_indexer.py → parse_sw_version()) │   │
│  │                                                                      │   │
│  │    버전 문자열 → 정렬 가능한 튜플 변환:                              │   │
│  │    "1.8.4-SP33-HF15" → (1, 8, 4, 33, 15)                            │   │
│  │    "1.8.4-SP33-HF16" → (1, 8, 4, 33, 16)                            │   │
│  │                                                                      │   │
│  │    특수 케이스:                                                      │   │
│  │    • "SP33-Release" → (1, 8, 4, 33, 0)  # HF 없음 = 0               │   │
│  │    • "SP33-B2" → (1, 8, 4, 33, -2)      # B빌드 = 음수              │   │
│  │    • "SP33-HF9e" → (1, 8, 4, 33, 9.5)   # 알파벳 소수점 처리        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3단계: 버전 범위 PR 추출 (swrn_indexer.py → get_prs_between_versions)│   │
│  │                                                                      │   │
│  │    SELECT DISTINCT f.sw_version, p.pr_number, p.context, p.pr_type  │   │
│  │    FROM pr_index p                                                   │   │
│  │    JOIN pdf_files f ON p.file_id = f.id                             │   │
│  │    WHERE p.pr_number IS NOT NULL                                     │   │
│  │                                                                      │   │
│  │    ┌─────────────────────────────────────────────────────────────┐  │   │
│  │    │  Delta 계산 로직                                             │  │   │
│  │    │  ─────────────────────────────────────────────────────────  │  │   │
│  │    │  1. from_version 이하 모든 버전의 PR 수집 (base_prs)        │  │   │
│  │    │  2. from < version <= to 범위의 PR 수집                     │  │   │
│  │    │  3. 각 PR에 대해 is_new = (PR not in base_prs) 플래그 설정  │  │   │
│  │    │  4. 버전별로 그룹화 + 통계 생성                             │  │   │
│  │    └─────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4단계: Delta Summary HTML 생성                                       │   │
│  │                                                                      │   │
│  │    ┌───────────────────────────────────────────────────────────┐    │   │
│  │    │ 📊 Delta Summary                                          │    │   │
│  │    │ Base: SP33-HF15 → Target: SP33-HF16                       │    │   │
│  │    │ Versions: 1 | Total PRs: 15 | New: 12                     │    │   │
│  │    │ ──────────────────────────────────────────────────────── │    │   │
│  │    │ Features 🆕: 3        Bug Fixes 🔧: 12                    │    │   │
│  │    │ ──────────────────────────────────────────────────────── │    │   │
│  │    │ 📦 PRs by Version                                         │    │   │
│  │    │ SP33-HF16: 15                                             │    │   │
│  │    │ ──────────────────────────────────────────────────────── │    │   │
│  │    │ 📥 Download CSV (15 PRs)                                  │    │   │
│  │    │ ──────────────────────────────────────────────────────── │    │   │
│  │    │ PR#      | Component | Module | Issue | Version | Type    │    │   │
│  │    │ PR-19900 | Etch     | RF     | ...   | SP33-HF16| 🔧      │    │   │
│  │    │ ...                                                       │    │   │
│  │    └───────────────────────────────────────────────────────────┘    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 8.6 SWRN PR Extract (단일 버전 PR 추출)

**사용법**: `SP33-HF16에 추가된 PR 알려줘`

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      SWRN PR Extract 처리 흐름                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  사용자 입력: "SP33-HF16에 추가된 PR 알려줘"                                │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1단계: 단일 버전 패턴 감지                                           │   │
│  │                                                                      │   │
│  │    버전 패턴 매칭: 1개 버전만 검출됨                                  │   │
│  │    → version_to: "1.8.4-SP33-HF16"                                  │   │
│  │                                                                      │   │
│  │    ★ 이전 버전 자동 계산: _get_previous_version()                    │   │
│  │    → version_from: "1.8.4-SP33-HF15" (HF16 - 1)                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 2단계: 이전 버전 계산 로직                                           │   │
│  │                                                                      │   │
│  │    ┌─────────────────────────────────────────────────────────────┐  │   │
│  │    │  _get_previous_version() 규칙                                │  │   │
│  │    │  ─────────────────────────────────────────────────────────  │  │   │
│  │    │  SP33-HF16  → SP33-HF15   (HF 번호 -1)                      │  │   │
│  │    │  SP33-HF1   → SP33-Release (HF1의 이전은 Release)           │  │   │
│  │    │  SP33-HF9e  → SP33-HF9d   (알파벳 -1)                       │  │   │
│  │    │  SP33-HF9a  → SP33-HF9    (a의 이전은 숫자만)               │  │   │
│  │    │  SP33-Release → SP32-Release (SP 번호 -1)                   │  │   │
│  │    │  SP33-B2    → SP33-B1     (B빌드 번호 -1)                   │  │   │
│  │    │  SP33-B1    → SP33-Release (B1의 이전은 Release)            │  │   │
│  │    └─────────────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 3단계: SWRN Compare와 동일한 처리                                    │   │
│  │                                                                      │   │
│  │    get_prs_between_versions("SP33-HF15", "SP33-HF16")               │   │
│  │    → 이전 버전과 현재 버전 사이의 Delta 계산                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│         │                                                                   │
│         ▼                                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 4단계: Delta Summary HTML 생성 (SWRN Compare와 동일)                 │   │
│  │                                                                      │   │
│  │    → "SP33-HF16에 새로 추가된 PR" 목록 출력                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

### 8.7 검색 기능별 데이터 흐름 요약

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    5가지 검색 기능 데이터 흐름 비교                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  [사용자 질문]                                                              │
│       │                                                                     │
│       ▼                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    local_rag.py (쿼리 라우터)                        │   │
│  │                                                                      │   │
│  │   _check_pr_query() ──────────────────────────────────────────────┐ │   │
│  │       │ PR-XXXXXX 패턴?                                           │ │   │
│  │       │     ├── YES → [PR Search]                                 │ │   │
│  │       │     └── 키워드+PR 패턴? ─── YES → [Search for PR]        │ │   │
│  │       │                                                           │ │   │
│  │   _check_version_range_query() ───────────────────────────────────│ │   │
│  │       │ 버전 2개? ─── YES → [SWRN Compare]                        │ │   │
│  │       │ 버전 1개? ─── YES → [SWRN PR Extract]                     │ │   │
│  │       │                                                           │ │   │
│  │   설명 키워드? (설명해줘, explain) ─── YES → [Search for Keyword]  │ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│       │                                                                     │
│       ├──────────────────┬──────────────────┬─────────────────────────────│
│       ▼                  ▼                  ▼                              │
│  ┌──────────┐      ┌──────────┐      ┌──────────┐                         │
│  │ SQLite   │      │ TF-IDF   │      │ Ollama   │                         │
│  │ FTS5     │      │ Index    │      │ LLM      │                         │
│  │          │      │          │      │          │                         │
│  │ pr_index │      │ CSV/Excel│      │ Llama    │                         │
│  │ page_    │      │ 데이터   │      │ 3.2-3B   │                         │
│  │ content  │      │ 벡터화   │      │          │                         │
│  └──────────┘      └──────────┘      └──────────┘                         │
│       │                  │                  │                              │
│       │    ┌─────────────┴─────────────┐    │                              │
│       │    │        사용 조합          │    │                              │
│       │    ├───────────────────────────┤    │                              │
│       │    │ PR Search:       FTS5     │    │                              │
│       │    │ Search for PR:   FTS5     │    │                              │
│       │    │ Search Keyword:  TF-IDF+LLM│   │                              │
│       │    │ SWRN Compare:    FTS5     │    │                              │
│       │    │ SWRN PR Extract: FTS5     │    │                              │
│       │    └───────────────────────────┘    │                              │
│       ▼                                     ▼                              │
│  ┌───────────────────────────────────────────────────────────────────┐    │
│  │                      HTML 응답 생성                                │    │
│  └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 9. 기술 스택 요약

| 구분 | 기술 요소 | 버전/비고 |
|------|-----------|-----------|
| **Language** | Python | 3.8+ |
| **Web Framework** | Flask | 2.0+ |
| **Database** | SQLite | 3.9.0+ (FTS5 Enabled) |
| **Sparse Search** | SQLite FTS5 | BM25 랭킹 내장 |
| **Dense Search** | scikit-learn | TfidfVectorizer, Cosine Similarity |
| **Hybrid Search** | local_rag.py | Phrase Match + Version 정렬 |
| **LLM Engine** | ctransformers / Ollama | Llama-3.2-3B (GGUF Q4_K_M) |
| **PDF Processing** | PyMuPDF (fitz) | 1.23.0+ |
| **Data Processing** | pandas, openpyxl | CSV/Excel 처리 |

---

**문서 버전**: 2.5
**최종 수정일**: 2025년 12월 11일
**변경 이력**:
- v2.5 (2025.12.11): **검색 기능별 상세 아키텍처 섹션 추가**
  - 5가지 검색 기능 데이터 흐름 다이어그램
  - PR Search: 직접 PR 번호 조회 (SQLite FTS5 → PyMuPDF)
  - Search for PR: 키워드 기반 PR 검색 (FTS5 AND + Phrase Match 점수)
  - Search for Keyword: TF-IDF 벡터 검색 + Ollama LLM 응답 생성
  - SWRN Compare: 버전 범위 Delta Summary (parse_sw_version 튜플 비교)
  - SWRN PR Extract: 단일 버전 신규 PR 추출 (이전 버전 자동 계산)
  - 검색 기능별 데이터 소스 및 핵심 기술 비교표
  - 쿼리 라우터 로직 다이어그램
- v2.2 (2025.12.03): 하이브리드 검색 엔진 기술 상세 문서화
  - BM25 알고리즘 수학적 정의 추가
  - TF-IDF 벡터화 및 코사인 유사도 설명
  - Dense vs Sparse Retrieval 비교표
  - 하이브리드 점수 계산 공식 (α×BM25 + β×TF-IDF + γ×Keyword)
  - BERT/Neural Embedding 미사용 사유 명시
  - SynonymExpander 동의어 확장 시스템 설명
- v2.1 (2025.12.03): 고급 키워드 검색 및 PR 검색 알고리즘 섹션 추가
  - SW 버전 파싱 알고리즘 (parse_sw_version)
  - Phrase Match 점수 시스템 (2000/1500/1000/800/500점 체계)
  - FTS5 직접 검색 전략 (AND/OR 폴백)
  - 최종 정렬 알고리즘 상세 설명